<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>연차 관리 시스템 (최종 수정본)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style> .hidden { display: none; } </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <!-- 로그인 화면 -->
  <div id="loginSection" class="flex flex-col items-center justify-center min-h-screen">
    <div class="max-w-xl w-full bg-white rounded shadow p-6 text-center">
      <h1 class="text-3xl font-bold mb-6">연차 관리 시스템</h1>
      <div class="flex flex-col gap-6">
        <div id="employeeLoginContainer" class="space-y-4">
          <h2 class="text-xl font-semibold">직원 로그인</h2>
          <form id="employeeLoginForm" class="space-y-3">
            <input type="text" placeholder="직원 이름" class="w-full border p-3 rounded" required />
            <input type="password" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">로그인</button>
          </form>
          <button type="button" onclick="showOwnerLogin()" class="text-blue-600 underline">사업주 로그인</button>
        </div>
        <div id="ownerLoginContainer" class="hidden space-y-4">
          <h2 class="text-xl font-semibold">사업주 로그인</h2>
          <form id="adminLoginForm" class="space-y-3">
            <input type="email" id="adminLoginId" placeholder="관리자 이메일" class="w-full border p-3 rounded" required />
            <input type="password" id="adminLoginPass" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">로그인</button>
          </form>
          <button type="button" onclick="showEmployeeLogin()" class="text-blue-600 underline">직원 로그인으로 돌아가기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 직원 포털 -->
  <div id="employeePortal" class="hidden"></div>

  <!-- 관리자 포털 -->
  <div id="adminPortal" class="hidden">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold">연차 관리 (관리자)</h1>
        <button onclick="adminLogout()" class="px-3 py-1 text-sm bg-gray-300 rounded">로그아웃</button>
      </div>
      <div class="flex gap-4 mb-4">
        <button id="tabEmployees" class="tab-btn bg-blue-500 text-white px-3 py-2 rounded">직원 관리</button>
        <button id="tabSettings" class="tab-btn bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded">사업장 설정</button>
      </div>
      <div id="admEmployeeSection" class="section">
        <div class="bg-white shadow rounded p-4">
          <h2 class="text-lg font-semibold mb-3">직원 목록</h2>
          <table class="min-w-full divide-y divide-gray-200 mb-4">
            <thead class="bg-gray-50"><tr>
              <th class="p-2 text-left text-xs">ID</th><th class="p-2 text-left text-xs">이름</th>
              <th class="p-2 text-left text-xs">부서</th><th class="p-2 text-left text-xs">직책</th>
              <th class="p-2 text-center text-xs">수정/삭제</th>
            </tr></thead><tbody id="admEmployeesTable"></tbody>
          </table>
          <h3 class="text-md font-semibold mb-2">직원 추가</h3>
          <form id="admAddEmployeeForm" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
            <input id="admNewEmpName" type="text" placeholder="이름" class="p-2 border rounded" required />
            <select id="admNewEmpDept" class="p-2 border rounded" required><option value="" disabled selected>부서 선택</option></select>
            <select id="admNewEmpPosition" class="p-2 border rounded" required><option value="" disabled selected>직책 선택</option></select>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button>
          </form>
          <div id="editEmployeeFormContainer" class="hidden mt-8">
            <h3 class="text-md font-semibold mb-2">직원 정보 수정</h3>
            <form id="admEditEmployeeForm" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
              <input id="admEditEmpName" type="text" class="p-2 border rounded" required />
              <select id="admEditEmpDept" class="p-2 border rounded" required></select>
              <select id="admEditEmpPosition" class="p-2 border rounded" required></select>
              <div><button type="button" id="editCancelBtn" class="bg-gray-400 text-white px-4 py-2 rounded mr-2">취소</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">저장</button></div>
            </form>
          </div>
        </div>
      </div>
      <div id="admSettingsSection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4 space-y-6">
          <h2 class="text-lg font-semibold mb-2">사업장 설정</h2>
          <div>
            <h3 class="text-md font-semibold">부서 목록</h3>
            <table class="min-w-full mb-2"><thead class="bg-gray-50"><tr><th class="p-2 text-left text-xs">부서명</th><th class="p-2 text-right text-xs">삭제</th></tr></thead><tbody id="deptList"></tbody></table>
            <form id="addDeptForm" class="flex gap-2"><input id="newDeptName" type="text" placeholder="새 부서명" class="flex-grow p-2 border rounded" required /><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button></form>
          </div>
          <div>
            <h3 class="text-md font-semibold">직책 목록</h3>
            <table class="min-w-full mb-2"><thead class="bg-gray-50"><tr><th class="p-2 text-left text-xs">직책명</th><th class="p-2 text-right text-xs">삭제</th></tr></thead><tbody id="positionList"></tbody></table>
            <form id="addPositionForm" class="flex gap-2"><input id="newPositionName" type="text" placeholder="새 직책명" class="flex-grow p-2 border rounded" required /><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button></form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- 1. 전역 설정 (모두가 접근 가능) ---
    const SUPABASE_URL = 'https://chnqtrmlglqdmzqwsazm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNobnF0cm1sZ2xxZG16cXdzYXptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODUxOTksImV4cCI6MjA3MDA2MTE5OX0.HBvXKoFAQsIjyePoMgtOpYZePoOHO9dYekcAsY1G6gQ';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let editingEmpId = null;

    // --- 2. HTML에서 직접 호출하는 함수들 (항상 접근 가능) ---
    function showOwnerLogin() { document.getElementById('employeeLoginContainer').classList.add('hidden'); document.getElementById('ownerLoginContainer').classList.remove('hidden'); }
    function showEmployeeLogin() { document.getElementById('ownerLoginContainer').classList.add('hidden'); document.getElementById('employeeLoginContainer').classList.remove('hidden'); }
    async function adminLogout() { await db.auth.signOut(); location.reload(); }
    async function deleteEmployee(id) {
        if (!confirm(`ID ${id} 직원을 정말 삭제하시겠습니까?`)) return;
        try { const { error } = await db.from('employees').delete().eq('id', id); if (error) throw error; await renderAdmEmployees(); } catch (e) { alert('직원 삭제 실패'); }
    }
    async function deleteDept(id) {
        if (!confirm(`삭제하시겠습니까?`)) return;
        try { const { error } = await db.from('departments').delete().eq('id', id); if(error) throw error; await renderSettings(); } catch (e) { alert('부서 삭제 실패'); }
    }
    async function deletePosition(id) {
        if (!confirm(`삭제하시겠습니까?`)) return;
        try { const { error } = await db.from('positions').delete().eq('id', id); if(error) throw error; await renderSettings(); } catch (e) { alert('직책 삭제 실패'); }
    }
    async function showEditEmployee(id) {
        try {
            const { data: emp, error } = await db.from('employees').select('*').eq('id', id).single();
            if (error) throw error;
            editingEmpId = id;
            document.getElementById('admEditEmpName').value = emp.name;
            document.getElementById('admEditEmpDept').value = emp.dept;
            document.getElementById('admEditEmpPosition').value = emp.position;
            document.getElementById('editEmployeeFormContainer').classList.remove('hidden');
        } catch(e) { alert('직원 정보 로딩 실패'); }
    }
    
    // --- 3. 데이터 렌더링 함수들 ---
    async function renderAdmEmployees() {
      const { data, error } = await db.from('employees').select('*').order('id');
      if (error) { alert('직원 목록 로딩 실패'); return; }
      const tbody = document.getElementById('admEmployeesTable');
      tbody.innerHTML = '';
      (data || []).forEach(emp => {
        tbody.innerHTML += `<tr><td class="p-2">${emp.id}</td><td class="p-2">${emp.name}</td><td class="p-2">${emp.dept}</td><td class="p-2">${emp.position}</td><td class="p-2 text-center"><button class="text-blue-600 mr-2" onclick="showEditEmployee(${emp.id})">수정</button><button class="text-red-600" onclick="deleteEmployee(${emp.id})">삭제</button></td></tr>`;
      });
    }
    async function renderSettings() {
      const { data: depts, error: dErr } = await db.from('departments').select('*'); if (dErr) { alert('부서 로딩 실패'); return; }
      deptList.innerHTML = ''; (depts||[]).forEach(d => { deptList.innerHTML += `<tr><td class="p-2">${d.name}</td><td class="p-2 text-right"><button class="text-red-600" onclick="deleteDept(${d.id})">삭제</button></td></tr>`; });
      const { data: pos, error: pErr } = await db.from('positions').select('*'); if (pErr) { alert('직책 로딩 실패'); return; }
      positionList.innerHTML = ''; (pos||[]).forEach(p => { positionList.innerHTML += `<tr><td class="p-2">${p.name}</td><td class="p-2 text-right"><button class="text-red-600" onclick="deletePosition(${p.id})">삭제</button></td></tr>`; });
      await populateDeptPositionSelects();
    }
    async function populateDeptPositionSelects() {
      const { data: depts } = await db.from('departments').select('name');
      const { data: pos } = await db.from('positions').select('name');
      [admNewEmpDept, admEditEmpDept].forEach(sel => { sel.innerHTML = '<option value="" disabled selected>부서</option>'; (depts || []).forEach(d => sel.innerHTML += `<option value="${d.name}">${d.name}</option>`); });
      [admNewEmpPosition, admEditEmpPosition].forEach(sel => { sel.innerHTML = '<option value="" disabled selected>직책</option>'; (pos || []).forEach(p => sel.innerHTML += `<option value="${p.name}">${p.name}</option>`); });
    }

    // --- 4. 앱 실행 로직 (페이지 로드 후 실행) ---
    document.addEventListener('DOMContentLoaded', () => {
      const loginSection = document.getElementById('loginSection');
      const adminPortal = document.getElementById('adminPortal');

      const showAdminPortal = () => { loginSection.classList.add('hidden'); adminPortal.classList.remove('hidden'); initializeAdminPortal(); };
      const showAdminSection = (name) => {
        ['admEmployeeSection', 'admSettingsSection'].forEach(id => { document.getElementById(id).style.display = id === name ? 'block' : 'none'; });
        ['tabEmployees', 'tabSettings'].forEach(id => {
          const tab = document.getElementById(id);
          if(id.toLowerCase().includes(name.toLowerCase())) {
            tab.classList.add('bg-blue-500', 'text-white'); tab.classList.remove('bg-gray-200', 'hover:bg-gray-300');
          } else {
            tab.classList.remove('bg-blue-500', 'text-white'); tab.classList.add('bg-gray-200', 'hover:bg-gray-300');
          }
        });
      };
      
      const initializeAdminPortal = async () => {
        showAdminSection('employees');
        await renderAdmEmployees();
        await populateDeptPositionSelects();
        document.getElementById('tabEmployees').onclick = async () => { showAdminSection('employees'); await renderAdmEmployees(); };
        document.getElementById('tabSettings').onclick = async () => { showAdminSection('settings'); await renderSettings(); };
      };

      // --- 이벤트 리스너 연결 ---
      document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('adminLoginId').value.trim();
        const password = document.getElementById('adminLoginPass').value.trim();
        try { const { error } = await db.auth.signInWithPassword({ email, password }); if (error) throw error; showAdminPortal(); } catch (error) { alert(`로그인 실패: ${error.message}`); }
      });
      document.getElementById('employeeLoginForm').addEventListener('submit', (e) => { e.preventDefault(); alert('직원 로그인 기능은 아직 개발 중입니다.'); });
      document.getElementById('admAddEmployeeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newEmp = { name: admNewEmpName.value, dept: admNewEmpDept.value, position: admNewEmpPosition.value };
        try { const { error } = await db.from('employees').insert([newEmp]); if (error) throw error; e.target.reset(); await renderAdmEmployees(); } catch(e) { alert('직원 추가 실패'); }
      });
      document.getElementById('admEditEmployeeForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const updatedInfo = { name: admEditEmpName.value, dept: admEditEmpDept.value, position: admEditEmpPosition.value };
          try { const { error } = await db.from('employees').update(updatedInfo).eq('id', editingEmpId); if (error) throw error; alert('수정 완료'); document.getElementById('editEmployeeFormContainer').classList.add('hidden'); await renderAdmEmployees(); } catch(e) { alert('수정 실패'); }
      });
      document.getElementById('editCancelBtn').addEventListener('click', () => { document.getElementById('editEmployeeFormContainer').classList.add('hidden'); });
      document.getElementById('addDeptForm').addEventListener('submit', async (e) => {
        e.preventDefault(); const name = newDeptName.value.trim();
        try { const { error } = await db.from('departments').insert([{ name }]); if(error) throw error; newDeptName.value = ''; await renderSettings(); } catch(error) { alert('부서 추가 실패'); }
      });
      document.getElementById('addPositionForm').addEventListener('submit', async (e) => {
        e.preventDefault(); const name = newPositionName.value.trim();
        try { const { error } = await db.from('positions').insert([{ name }]); if(error) throw error; newPositionName.value = ''; await renderSettings(); } catch(error) { alert('직책 추가 실패'); }
      });
    });
  </script>
</body>
</html>