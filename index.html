<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>연차 관리 시스템 (DB 최종본)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style> .hidden { display: none; } </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <!-- 로그인 화면 -->
  <div id="loginSection" class="flex flex-col items-center justify-center min-h-screen">
    <div class="max-w-xl w-full bg-white rounded shadow p-6 text-center">
      <h1 class="text-3xl font-bold mb-6">연차 관리 시스템</h1>
      <div class="flex flex-col gap-6">
        <div id="employeeLoginContainer" class="space-y-4">
          <h2 class="text-xl font-semibold">직원 로그인</h2>
          <form id="employeeLoginForm" class="space-y-3">
            <input type="text" id="empLoginName" placeholder="직원 이름" class="w-full border p-3 rounded" required />
            <input type="password" id="empLoginPass" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">로그인</button>
          </form>
          <button type="button" onclick="showOwnerLogin()" class="text-blue-600 underline">사업주 로그인</button>
        </div>
        <div id="ownerLoginContainer" class="hidden space-y-4">
          <h2 class="text-xl font-semibold">사업주 로그인</h2>
          <form id="adminLoginForm" class="space-y-3">
            <input type="email" id="adminLoginId" placeholder="관리자 이메일" class="w-full border p-3 rounded" required />
            <input type="password" id="adminLoginPass" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">로그인</button>
          </form>
          <button type="button" onclick="showEmployeeLogin()" class="text-blue-600 underline">직원 로그인으로 돌아가기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 직원 포털 (아직 비어 있음) -->
  <div id="employeePortal" class="hidden"></div>

  <!-- 관리자 포털 (내용물 채워짐) -->
  <div id="adminPortal" class="hidden">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold">연차 관리 (관리자)</h1>
        <button onclick="adminLogout()" class="px-3 py-1 text-sm bg-gray-300 rounded">로그아웃</button>
      </div>
      <div class="flex gap-4 mb-4">
        <button id="tabEmployees" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">직원 관리</button>
        <button id="tabSettings" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">사업장 설정</button>
      </div>
      <div id="admEmployeeSection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4">
          <h2 class="text-lg font-semibold mb-3">직원 목록</h2>
          <table class="min-w-full divide-y divide-gray-200 mb-4">
            <thead class="bg-gray-50"><tr>
              <th class="p-2 text-left text-xs font-medium text-gray-500">ID</th>
              <th class="p-2 text-left text-xs font-medium text-gray-500">이름</th>
              <th class="p-2 text-left text-xs font-medium text-gray-500">부서</th>
              <th class="p-2 text-left text-xs font-medium text-gray-500">직책</th>
              <th class="p-2 text-center text-xs font-medium text-gray-500">삭제</th>
            </tr></thead>
            <tbody id="admEmployeesTable"></tbody>
          </table>
          <h3 class="text-md font-semibold mb-2">직원 추가</h3>
          <form id="admAddEmployeeForm" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
            <input id="admNewEmpName" type="text" placeholder="이름" class="p-2 border rounded" required />
            <input id="admNewEmpDept" type="text" placeholder="부서" class="p-2 border rounded" required />
            <input id="admNewEmpPosition" type="text" placeholder="직책" class="p-2 border rounded" required />
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button>
          </form>
        </div>
      </div>
      <div id="admSettingsSection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4 space-y-6">
          <h2 class="text-lg font-semibold mb-2">사업장 설정</h2>
          <div>
            <h3 class="text-md font-semibold mb-2">부서 목록</h3>
            <table class="min-w-full divide-y divide-gray-200 mb-2">
              <thead class="bg-gray-50"><tr><th class="p-2 text-left text-xs font-medium text-gray-500">부서명</th><th class="p-2 text-right text-xs font-medium text-gray-500">삭제</th></tr></thead>
              <tbody id="deptList"></tbody>
            </table>
            <form id="addDeptForm" class="flex gap-2"><input id="newDeptName" type="text" placeholder="새 부서명" class="flex-grow p-2 border rounded" required /><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button></form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- 1. SUPABASE 클라이언트 설정 ---
      const SUPABASE_URL = 'https://chnqtrmlglqdmzqwsazm.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNobnF0cm1sZ2xxZG16cXdzYXptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODUxOTksImV4cCI6MjA3MDA2MTE5OX0.HBvXKoFAQsIjyePoMgtOpYZePoOHO9dYekcAsY1G6gQ';
      const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // --- DOM 요소 변수 ---
      const loginSection = document.getElementById('loginSection');
      const employeeLoginContainer = document.getElementById('employeeLoginContainer');
      const ownerLoginContainer = document.getElementById('ownerLoginContainer');
      const adminPortal = document.getElementById('adminPortal');
      const employeePortal = document.getElementById('employeePortal');
      
      // --- 화면 전환 함수 ---
      window.showOwnerLogin = () => { employeeLoginContainer.classList.add('hidden'); ownerLoginContainer.classList.remove('hidden'); };
      window.showEmployeeLogin = () => { ownerLoginContainer.classList.add('hidden'); employeeLoginContainer.classList.remove('hidden'); };
      const showAdminPortal = () => { loginSection.classList.add('hidden'); adminPortal.classList.remove('hidden'); initializeAdminPortal(); };
      const showEmployeePortal = () => { loginSection.classList.add('hidden'); employeePortal.classList.remove('hidden'); };
      const showAdminSection = (name) => {
        ['admEmployeeSection', 'admSettingsSection'].forEach(id => {
          document.getElementById(id).style.display = id === name ? 'block' : 'none';
        });
      };
      
      // --- 관리자 포털 초기화 ---
      const initializeAdminPortal = () => {
        showAdminSection('employees');
        renderAdmEmployees();
        document.getElementById('tabEmployees').onclick = () => { showAdminSection('employees'); renderAdmEmployees(); };
        document.getElementById('tabSettings').onclick = () => { showAdminSection('settings'); renderSettings(); };
      };

      // --- 이벤트 리스너 ---
      document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('adminLoginId').value.trim();
        const password = document.getElementById('adminLoginPass').value.trim();
        try {
          const { data, error } = await db.auth.signInWithPassword({ email, password });
          if (error) throw error;
          showAdminPortal();
        } catch (error) { alert(`로그인 실패: ${error.message}`); }
      });
      document.getElementById('employeeLoginForm').addEventListener('submit', (e) => { e.preventDefault(); alert('직원 로그인 기능은 개발 중입니다.'); });
      window.adminLogout = async () => { await db.auth.signOut(); location.reload(); };

      // --- DB 연동 함수: 직원 관리 ---
      const renderAdmEmployees = async () => {
        const { data, error } = await db.from('employees').select('*').order('id');
        if (error) { alert('직원 목록 로딩 실패'); return; }
        const tbody = document.getElementById('admEmployeesTable');
        tbody.innerHTML = '';
        (data || []).forEach(emp => {
          tbody.innerHTML += `<tr><td class="p-2">${emp.id}</td><td class="p-2">${emp.name}</td><td class="p-2">${emp.dept}</td><td class="p-2">${emp.position}</td><td class="p-2 text-center"><button class="text-red-600" onclick="deleteEmployee(${emp.id})">삭제</button></td></tr>`;
        });
      };
      document.getElementById('admAddEmployeeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newEmp = { name: admNewEmpName.value, dept: admNewEmpDept.value, position: admNewEmpPosition.value };
        const { error } = await db.from('employees').insert([newEmp]);
        if(error) alert('직원 추가 실패'); else { e.target.reset(); renderAdmEmployees(); }
      });
      window.deleteEmployee = async (id) => {
        if (!confirm(`ID ${id} 직원을 삭제하시겠습니까?`)) return;
        const { error } = await db.from('employees').delete().eq('id', id);
        if(error) alert('직원 삭제 실패'); else renderAdmEmployees();
      };
      
      // --- DB 연동 함수: 사업장 설정 ---
      const renderSettings = async () => {
        const { data, error } = await db.from('departments').select('*');
        if (error) { alert('부서 목록 로딩 실패'); return; }
        const tbody = document.getElementById('deptList');
        tbody.innerHTML = '';
        (data || []).forEach(dept => {
          tbody.innerHTML += `<tr><td class="p-2">${dept.name}</td><td class="p-2 text-right"><button class="text-red-600" onclick="deleteDept(${dept.id})">삭제</button></td></tr>`;
        });
      };
      document.getElementById('addDeptForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = newDeptName.value.trim();
        const { error } = await db.from('departments').insert([{ name }]);
        if(error) alert('부서 추가 실패'); else { newDeptName.value = ''; renderSettings(); }
      });
      window.deleteDept = async (id) => {
        if (!confirm('부서를 삭제하시겠습니까?')) return;
        const { error } = await db.from('departments').delete().eq('id', id);
        if(error) alert('부서 삭제 실패'); else renderSettings();
      };
    });
  </script>
</body>
</html>