<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>연차 관리 시스템 (Supabase 최종 복원)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .hidden { display: none; }
    .fc-daygrid-day.selected { background-color: #c7e0ff !important; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <!-- 로그인 화면 -->
  <div id="loginSection" class="flex flex-col items-center justify-center min-h-screen">
    <div class="max-w-xl w-full bg-white rounded shadow p-6 text-center">
      <h1 class="text-3xl font-bold mb-6">연차 관리 시스템</h1>
      <p class="mb-4 text-gray-600">사용자 유형을 선택하여 로그인하세요.</p>
      <div class="flex flex-col gap-6">
        <!-- 직원 로그인 -->
        <div id="employeeLoginContainer" class="space-y-4">
          <h2 class="text-xl font-semibold text-gray-700">직원 로그인</h2>
          <form id="employeeLoginForm" class="space-y-3">
            <input type="text" id="empLoginName" placeholder="직원 이름" class="w-full border p-3 rounded" required />
            <input type="password" id="empLoginPass" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">로그인</button>
          </form>
          <button type="button" id="goToOwnerLoginBtn" class="text-blue-600 underline">사업주 로그인</button>
        </div>
        <!-- 사업주 로그인 -->
        <div id="ownerLoginContainer" class="hidden space-y-4">
          <h2 class="text-xl font-semibold text-gray-700">사업주 로그인</h2>
          <form id="adminLoginForm" class="space-y-3">
            <input type="email" id="adminLoginId" placeholder="사업주 이메일" class="w-full border p-3 rounded" required />
            <input type="password" id="adminLoginPass" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">로그인</button>
          </form>
          <div class="flex justify-between items-center text-sm">
            <button type="button" id="goToEmployeeLoginBtn" class="text-blue-600 underline">직원 로그인으로</button>
            <div class="space-x-4">
              <button type="button" id="showRegisterFormBtn" class="text-blue-600 underline">사업주 가입</button>
              <button type="button" id="showResetFormBtn" class="text-blue-600 underline">비밀번호 초기화</button>
            </div>
          </div>
          <!-- 사업주 가입 -->
          <div id="ownerRegisterSection" class="mt-4 hidden">
            <h3 class="text-sm font-semibold mb-2">➕ 사업주 가입하기</h3>
            <form id="registerOwnerForm" class="space-y-3">
              <input type="email" id="newOwnerEmail" placeholder="이메일 주소" class="w-full p-3 border rounded" required />
              <input type="password" id="newOwnerPass" placeholder="비밀번호" class="w-full p-3 border rounded" required />
              <button type="submit" class="w-full bg-gray-700 hover:bg-gray-800 text-white py-2 rounded">가입</button>
            </form>
          </div>
          <!-- 비밀번호 초기화 -->
          <div id="resetStep1" class="mt-4 hidden">
            <h3 class="text-sm font-semibold mb-2">비밀번호 초기화 요청</h3>
            <form id="resetRequestForm" class="space-y-3">
              <input type="email" id="resetOwnerEmail" placeholder="가입한 이메일" class="w-full p-3 border rounded" required />
              <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">초기화 링크 보내기</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 직원 포털 -->
  <div id="employeePortal" class="hidden">
    <div class="max-w-5xl mx-auto bg-white shadow rounded p-6">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">내 연차 신청</h1>
        <div><span id="employeeInfo" class="text-sm text-gray-600"></span><button id="employeeLogoutBtn" class="ml-2 px-3 py-1 text-sm bg-gray-300 rounded">로그아웃</button></div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 text-center mb-6 text-sm">
        <div class="bg-blue-100 p-3 rounded"><p>총 연차</p><p class="text-xl font-bold" id="empTotalLeave">0일</p></div>
        <div class="bg-yellow-100 p-3 rounded"><p>승인 대기</p><p class="text-xl font-bold" id="empPendingLeave">0일</p></div>
        <div class="bg-green-100 p-3 rounded"><p>승인 완료</p><p class="text-xl font-bold" id="empApprovedLeave">0일</p></div>
        <div class="bg-gray-200 p-3 rounded"><p>사용 연차</p><p class="text-xl font-bold" id="empUsedLeave">0일</p></div>
        <div class="bg-red-100 p-3 rounded"><p>잔여 연차</p><p class="text-xl font-bold" id="empRemainingLeave">0일</p></div>
      </div>
      <div id="empCalendar"></div>
      <div class="text-right mt-4"><button id="empApplyBtn" class="bg-blue-600 text-white px-4 py-2 rounded">연차 신청</button></div>
    </div>
    <div id="empFormContainer" class="max-w-2xl mx-auto mt-8 bg-white shadow rounded p-6 hidden">
      <h2 class="text-xl font-semibold mb-4">연차 신청서</h2>
      <form id="empLeaveForm" class="space-y-4">
        <div><label class="block font-medium">선택 날짜 (<span id="empSelectedCount">0</span>일)</label><ul id="empSelectedDatesList" class="list-disc list-inside"></ul></div>
        <div><label class="block font-medium mb-1">사유</label><textarea id="empReason" class="w-full p-2 border rounded" rows="3" required></textarea></div>
        <div class="flex justify-end gap-2"><button type="button" id="empCancelBtn" class="bg-gray-400 text-white px-4 py-2 rounded">취소</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">제출</button></div>
      </form>
    </div>
  </div>

  <!-- 관리자 포털 -->
  <div id="adminPortal" class="hidden">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">연차 관리 (관리자)</h1><button id="adminLogoutBtn" class="px-3 py-1 text-sm bg-gray-300 rounded">로그아웃</button></div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center mb-6 text-sm">
        <div class="bg-yellow-100 p-4 rounded"><p>승인 대기</p><p class="text-xl font-bold" id="admSummaryPending">0건</p></div>
        <div class="bg-green-100 p-4 rounded"><p>승인 완료</p><p class="text-xl font-bold" id="admSummaryApproved">0건</p></div>
        <div class="bg-gray-200 p-4 rounded"><p>사용 완료</p><p class="text-xl font-bold" id="admSummaryUsed">0건</p></div>
        <div class="bg-red-100 p-4 rounded"><p>반려</p><p class="text-xl font-bold" id="admSummaryRejected">0건</p></div>
      </div>
      <div class="flex gap-4 mb-4">
        <button id="tabList" class="tab-btn bg-blue-500 text-white px-3 py-2 rounded">연차 목록</button>
        <button id="tabEmployees" class="tab-btn bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded">직원 관리</button>
        <button id="tabSettings" class="tab-btn bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded">사업장 설정</button>
      </div>
      <div id="admLeaveListSection" class="section">
          <div class="bg-white shadow rounded overflow-x-auto p-4"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="p-2 text-left text-xs">직원</th><th class="p-2 text-left text-xs">신청날짜</th><th class="p-2 text-left text-xs">사유</th><th class="p-2 text-left text-xs">상태</th><th class="p-2 text-center text-xs">처리</th></tr></thead><tbody id="admRequestsTable"></tbody></table></div>
      </div>
      <div id="admEmployeeSection" class="section" style="display:none;">
          <div class="bg-white shadow rounded p-4"><h2 class="text-lg font-semibold mb-3">직원 목록</h2><table class="min-w-full divide-y divide-gray-200 mb-4"><thead class="bg-gray-50"><tr><th class="p-2 text-left text-xs">ID</th><th class="p-2 text-left text-xs">이름</th><th class="p-2 text-left text-xs">부서</th><th class="p-2 text-left text-xs">입사일</th><th class="p-2 text-center text-xs">액션</th></tr></thead><tbody id="admEmployeesTable"></tbody></table><h3 class="text-md font-semibold mb-2">직원 추가</h3><form id="admAddEmployeeForm" class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-4"><input id="admNewEmpName" type="text" placeholder="이름" class="p-2 border rounded" required /><select id="admNewEmpDept" class="p-2 border rounded" required><option value="" disabled selected>부서</option></select><select id="admNewEmpPosition" class="p-2 border rounded" required><option value="" disabled selected>직책</option></select><input id="admNewEmpEntryDate" type="date" class="p-2 border rounded" required /><input id="admNewEmpPassword" type="password" placeholder="로그인 비번" class="p-2 border rounded" required /><div class="md:col-span-5 text-right"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button></div></form></div>
      </div>
      <div id="admSettingsSection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4 space-y-6">
            <div><h3 class="text-md font-semibold">부서 목록</h3><table class="min-w-full mb-2"><tbody id="deptList"></tbody></table><form id="addDeptForm" class="flex gap-2"><input id="newDeptName" type="text" placeholder="새 부서명" class="flex-grow p-2 border rounded" required /><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button></form></div>
            <div><h3 class="text-md font-semibold">직책 목록</h3><table class="min-w-full mb-2"><tbody id="positionList"></tbody></table><form id="addPositionForm" class="flex gap-2"><input id="newPositionName" type="text" placeholder="새 직책명" class="flex-grow p-2 border rounded" required /><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button></form></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script>
    // --- Supabase 설정 ---
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // ◀◀◀ 여기에 Supabase URL을 입력하세요.
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // ◀◀◀ 여기에 Supabase Anon Key를 입력하세요.
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- 전역 변수 ---
    let currentEmployee = null;
    let empCalendar;
    let selectedDates = new Set();
    
    // --- 유틸리티 및 공용 함수 ---
    const _ = (id) => document.getElementById(id);
    const show = (id) => _(id)?.classList.remove('hidden');
    const hide = (id) => _(id)?.classList.add('hidden');
    const calculateLegalLeave = (emp) => {
        if (!emp || !emp.entry_date) return 15; // 기본값
        const entry = dayjs(emp.entry_date);
        const years = dayjs().diff(entry, 'year', true);
        if (years < 1) return Math.min(dayjs().diff(entry, 'month') + 1, 11);
        return 15 + Math.floor((Math.floor(years) - 1) / 2);
    };

    // --- 화면 전환 ---
    const showOwnerLogin = () => { hide('employeeLoginContainer'); show('ownerLoginContainer'); };
    const showEmployeeLogin = () => { hide('ownerLoginContainer'); show('employeeLoginContainer'); };
    const showLoginScreen = () => { show('loginSection'); hide('adminPortal'); hide('employeePortal'); };
    const showAdminPortal = () => { hide('loginSection'); show('adminPortal'); initializeAdminPortal(); };
    const showEmployeePortal = () => { hide('loginSection'); show('employeePortal'); initializeEmployeePortal(); };
    
    const employeeLogout = () => { sessionStorage.removeItem('loggedInEmployee'); currentEmployee = null; location.reload(); };
    const adminLogout = async () => { await db.auth.signOut(); location.reload(); };

    const toggleOwnerSubSection = (sectionToShow) => {
        ['ownerRegisterSection', 'resetStep1'].forEach(id => hide(id));
        if (sectionToShow) show(sectionToShow);
    };

    // --- 직원 포털 ---
    async function initializeEmployeePortal() {
        if (!currentEmployee) { location.reload(); return; }
        _('employeeInfo').textContent = `${currentEmployee.name} (${currentEmployee.dept || ''})`;
        
        const calendarEl = _('empCalendar');
        if (empCalendar) empCalendar.destroy();
        empCalendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            dateClick: (info) => {
                selectedDates.has(info.dateStr) ? selectedDates.delete(info.dateStr) : selectedDates.add(info.dateStr);
                info.dayEl.classList.toggle('selected');
                renderSelectedDates();
            }
        });
        empCalendar.render();
        await refreshEmployeeData();
    }
    
    async function refreshEmployeeData() {
        if (!currentEmployee) return;
        try {
            const { data: requests, error } = await db.from('leave_requests').select('*');
            if (error) throw error;
            
            const totalLeave = calculateLegalLeave(currentEmployee);
            let pending = 0, approved = 0, used = 0;
            const myRequests = requests.filter(r => r.employee_id === currentEmployee.id);
            myRequests.forEach(req => {
                if (req.status === 'pending') pending += req.dates.length;
                else if (req.status === 'approved') {
                    req.dates.forEach(d => { dayjs(d).isBefore(dayjs(), 'day') ? used++ : approved++; });
                }
            });
            _('empTotalLeave').textContent = `${totalLeave}일`;
            _('empPendingLeave').textContent = `${pending}일`;
            _('empApprovedLeave').textContent = `${approved}일`;
            _('empUsedLeave').textContent = `${used}일`;
            _('empRemainingLeave').textContent = `${totalLeave - approved - used}일`;
            
            const events = requests.map(req => ({
                title: req.employee_name,
                start: req.dates[0],
                end: dayjs(req.dates[req.dates.length - 1]).add(1, 'day').format('YYYY-MM-DD'),
                backgroundColor: req.status === 'approved' ? '#34d399' : '#facc15'
            }));
            empCalendar.removeAllEvents();
            empCalendar.addEventSource(events);
        } catch (e) {
            alert('연차 데이터 로딩 실패: ' + e.message);
        }
    }

    function renderSelectedDates() {
        _('empSelectedCount').textContent = selectedDates.size;
        _('empSelectedDatesList').innerHTML = Array.from(selectedDates).sort().map(d => `<li>${d}</li>`).join('');
    }

    // --- 관리자 포털 ---
    async function initializeAdminPortal() {
        showAdminSection('list');
        await updateAdminSummary();
        await renderAdmRequestTable();
        await populateDeptPositionSelects();
    }

    function showAdminSection(name) {
        ['admLeaveListSection', 'admEmployeeSection', 'admSettingsSection'].forEach(id => hide(id));
        show(name === 'list' ? 'admLeaveListSection' : (name === 'employees' ? 'admEmployeeSection' : 'admSettingsSection'));

        ['tabList', 'tabEmployees', 'tabSettings'].forEach(id => {
            const tab = _(id);
            tab.classList.remove('bg-blue-500', 'text-white');
            tab.classList.add('bg-gray-200');
        });
        const activeTab = _(name === 'list' ? 'tabList' : (name === 'employees' ? 'tabEmployees' : 'tabSettings'));
        activeTab.classList.add('bg-blue-500', 'text-white');
        activeTab.classList.remove('bg-gray-200');
    }
    
    async function updateAdminSummary() {
        try {
            const { data, error } = await db.from('leave_requests').select('status,dates');
            if (error) throw error;
            let pending = 0, approved = 0, used = 0, rejected = 0;
            const today = dayjs();
            (data || []).forEach(req => {
                if (req.status === 'pending') pending++;
                else if (req.status === 'approved') {
                    const isUsed = req.dates.some(d => dayjs(d).isBefore(today, 'day'));
                    if (isUsed) used++; else approved++;
                } else if (req.status === 'rejected') rejected++;
            });
            _('admSummaryPending').textContent = `${pending}건`;
            _('admSummaryApproved').textContent = `${approved}건`;
            _('admSummaryUsed').textContent = `${used}건`;
            _('admSummaryRejected').textContent = `${rejected}건`;
        } catch(e) { console.error("요약 업데이트 실패", e); }
    }
    
    async function renderAdmRequestTable() {
        try {
            const { data, error } = await db.from('leave_requests').select('*').order('id', { ascending: false });
            if (error) throw error;
            _('admRequestsTable').innerHTML = (data || []).map(req => {
                let actions = '-';
                if (req.status === 'pending') {
                    actions = `<button class="text-green-600 mr-2" onclick="updateRequestStatus(${req.id}, 'approved')">승인</button>
                               <button class="text-red-600" onclick="updateRequestStatus(${req.id}, 'rejected')">반려</button>`;
                }
                return `<tr>
                    <td class="p-2 text-sm">${req.employee_name}</td>
                    <td class="p-2 text-sm">${(req.dates || []).join(', ')}</td>
                    <td class="p-2 text-sm">${req.reason}</td>
                    <td class="p-2 text-sm">${req.status}</td>
                    <td class="p-2 text-center">${actions}</td>
                </tr>`;
            }).join('');
        } catch(e) { alert(`연차 목록 로딩 실패: ${e.message}`); }
    }
    
    async function renderAdmEmployees() {
        try{
            const { data, error } = await db.from('employees').select('*').order('id');
            if (error) throw error;
            _('admEmployeesTable').innerHTML = (data || []).map(emp => `
                <tr>
                    <td class="p-2">${emp.id}</td><td class="p-2">${emp.name}</td>
                    <td class="p-2">${emp.dept}</td><td class="p-2">${emp.entry_date}</td>
                    <td class="p-2 text-center">
                        <button class="text-red-600" onclick="deleteEmployee(${emp.id})">삭제</button>
                    </td>
                </tr>`).join('');
        } catch(e) { alert('직원 목록 로딩 실패'); }
    }
    
    async function renderSettings() {
        try {
            const { data: depts, error: dErr } = await db.from('departments').select('*');
            if (dErr) throw dErr;
            _('deptList').innerHTML = (depts||[]).map(d => `<tr><td class="p-2">${d.name}</td><td class="p-2 text-right"><button class="text-red-600" onclick="deleteDept(${d.id})">삭제</button></td></tr>`).join('');
            
            const { data: pos, error: pErr } = await db.from('positions').select('*');
            if (pErr) throw pErr;
            _('positionList').innerHTML = (pos||[]).map(p => `<tr><td class="p-2">${p.name}</td><td class="p-2 text-right"><button class="text-red-600" onclick="deletePosition(${p.id})">삭제</button></td></tr>`).join('');
        } catch(e) { alert('설정 정보 로딩 실패'); }
    }
    
    async function populateDeptPositionSelects() {
        try {
            const { data: depts } = await db.from('departments').select('name');
            const { data: pos } = await db.from('positions').select('name');
            _('admNewEmpDept').innerHTML = '<option value="" disabled selected>부서</option>' + (depts || []).map(d => `<option value="${d.name}">${d.name}</option>`).join('');
            _('admNewEmpPosition').innerHTML = '<option value="" disabled selected>직책</option>' + (pos || []).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        } catch(e) { alert('부서/직책 로딩 실패'); }
    }

    // --- 데이터 CRUD 함수 (onclick에서 호출되므로 전역 스코프에 둡니다) ---
    window.updateRequestStatus = async (id, status) => {
        if(!confirm(`'${status}' 상태로 변경하시겠습니까?`)) return;
        try {
            const { error } = await db.from('leave_requests').update({ status }).eq('id', id);
            if (error) throw error;
            alert('상태 변경 완료');
            await renderAdmRequestTable();
            await updateAdminSummary();
        } catch(e) { alert(`상태 변경 실패: ${e.message}`); }
    };

    window.deleteEmployee = async (id) => {
        if (!confirm(`직원을 삭제하시겠습니까?`)) return;
        try {
            const { error } = await db.from('employees').delete().eq('id', id);
            if (error) throw error;
            await renderAdmEmployees();
        } catch (e) { alert('직원 삭제 실패'); }
    };

    window.deleteDept = async (id) => {
        if (!confirm(`부서를 삭제하시겠습니까?`)) return;
        try {
            const { error } = await db.from('departments').delete().eq('id', id);
            if(error) throw error;
            await renderSettings();
            await populateDeptPositionSelects();
        } catch (e) { alert('부서 삭제 실패'); }
    };

    window.deletePosition = async (id) => {
        if (!confirm(`직책을 삭제하시겠습니까?`)) return;
        try {
            const { error } = await db.from('positions').delete().eq('id', id);
            if(error) throw error;
            await renderSettings();
            await populateDeptPositionSelects();
        } catch (e) { alert('직책 삭제 실패'); }
    };
    
    // --- DOMContentLoaded: 앱 실행 ---
    document.addEventListener('DOMContentLoaded', async () => {
        // --- 세션 확인 및 라우팅 ---
        const { data: { session } } = await db.auth.getSession();
        const loggedInEmployee = sessionStorage.getItem('loggedInEmployee');

        if (session) {
            showAdminPortal();
        } else if (loggedInEmployee) {
            currentEmployee = JSON.parse(loggedInEmployee);
            showEmployeePortal();
        } else {
            showLoginScreen();
        }

        // --- 이벤트 리스너 등록 ---
        // 로그인 화면
        _('goToOwnerLoginBtn').addEventListener('click', showOwnerLogin);
        _('goToEmployeeLoginBtn').addEventListener('click', showEmployeeLogin);
        _('showRegisterFormBtn').addEventListener('click', () => toggleOwnerSubSection('ownerRegisterSection'));
        _('showResetFormBtn').addEventListener('click', () => toggleOwnerSubSection('resetStep1'));
        
        // 직원/사업주 로그아웃
        _('employeeLogoutBtn').addEventListener('click', employeeLogout);
        _('adminLogoutBtn').addEventListener('click', adminLogout);
        
        // 로그인/가입/초기화 폼 제출
        _('employeeLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = _('empLoginName').value.trim();
            const pass = _('empLoginPass').value.trim();
            try {
                const { data, error } = await db.from('employees').select('*').eq('name', name).eq('password', pass).single();
                if (error || !data) throw new Error('이름 또는 비밀번호가 올바르지 않습니다.');
                currentEmployee = data;
                sessionStorage.setItem('loggedInEmployee', JSON.stringify(data));
                showEmployeePortal();
            } catch (error) {
                alert(`로그인 실패: ${error.message}`);
            }
        });
        
        _('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = _('adminLoginId').value.trim();
            const password = _('adminLoginPass').value.trim();
            try {
                const { error } = await db.auth.signInWithPassword({ email, password });
                if (error) throw error;
                showAdminPortal();
            } catch (error) {
                alert(`로그인 실패: ${error.message}`);
            }
        });

        _('registerOwnerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = _('newOwnerEmail').value.trim();
            const password = _('newOwnerPass').value.trim();
            try {
                const { error } = await db.auth.signUp({ email, password });
                if (error) throw error;
                alert('가입 확인 이메일이 전송되었습니다. 이메일을 확인해주세요.');
                toggleOwnerSubSection(null);
            } catch (error) {
                alert('가입 실패: ' + error.message);
            }
        });
        
        _('resetRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = _('resetOwnerEmail').value.trim();
            try {
                const { error } = await db.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.href, // 사용자가 링크를 클릭 후 돌아올 페이지
                });
                if (error) throw error;
                alert('비밀번호 초기화 링크가 이메일로 전송되었습니다.');
                toggleOwnerSubSection(null);
            } catch (error) {
                alert('초기화 요청 실패: ' + error.message);
            }
        });
        
        // 직원 포털
        _('empApplyBtn').addEventListener('click', () => {
            if (selectedDates.size === 0) { alert('날짜를 선택해주세요.'); return; }
            show('empFormContainer');
        });
        _('empCancelBtn').addEventListener('click', () => hide('empFormContainer'));
        _('empLeaveForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const reason = _('empReason').value.trim();
            if(!reason) { alert('사유를 입력하세요.'); return; }
            try {
                const { error } = await db.from('leave_requests').insert([{
                    employee_id: currentEmployee.id,
                    employee_name: currentEmployee.name,
                    employee_dept: currentEmployee.dept,
                    dates: Array.from(selectedDates).sort(),
                    reason: reason,
                    status: 'pending',
                }]);
                if (error) throw error;
                alert('연차 신청 완료');
                selectedDates.clear();
                document.querySelectorAll('.fc-daygrid-day.selected').forEach(d => d.classList.remove('selected'));
                hide('empFormContainer');
                e.target.reset();
                await refreshEmployeeData();
            } catch(error) {
                alert(`연차 신청 실패: ${error.message}`);
            }
        });

        // 관리자 포털
        _('tabList').addEventListener('click', () => { showAdminSection('list'); renderAdmRequestTable(); });
        _('tabEmployees').addEventListener('click', () => { showAdminSection('employees'); renderAdmEmployees(); });
        _('tabSettings').addEventListener('click', () => { showAdminSection('settings'); renderSettings(); });

        _('admAddEmployeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newEmp = {
                name: _('admNewEmpName').value,
                dept: _('admNewEmpDept').value,
                position: _('admNewEmpPosition').value,
                entry_date: _('admNewEmpEntryDate').value,
                password: _('admNewEmpPassword').value
            };
            try {
                const { error } = await db.from('employees').insert([newEmp]);
                if (error) throw error;
                e.target.reset();
                await renderAdmEmployees();
            } catch(e) { alert('직원 추가 실패: ' + e.message); }
        });
        
        _('addDeptForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = _('newDeptName').value.trim();
            if(!name) return;
            try {
                const { error } = await db.from('departments').insert([{ name }]);
                if(error) throw error;
                _('newDeptName').value = '';
                await renderSettings();
                await populateDeptPositionSelects();
            } catch(error) { alert('부서 추가 실패'); }
        });

        _('addPositionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = _('newPositionName').value.trim();
            if(!name) return;
            try {
                const { error } = await db.from('positions').insert([{ name }]);
                if(error) throw error;
                _('newPositionName').value = '';
                await renderSettings();
                await populateDeptPositionSelects();
            } catch(error) { alert('직책 추가 실패'); }
        });
    });
  </script>
</body>
</html>