<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>연차 관리 시스템 (통합)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <!-- EmailJS library for password reset emails -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    .hidden { display: none; }
    /* 일정 선택 시 배경색 */
    .fc-daygrid-day.selected { background-color: #c7e0ff !important; }
    /* 상태에 따른 이벤트 테두리 */
    .fc-event-pending { border: 2px solid #facc15 !important; }
    .fc-event-approved { border: 2px solid #34d399 !important; }
    .fc-event-used { border: 2px solid #a3a3a3 !important; }
    .fc-event-rejected { border: 2px solid #f87171 !important; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <!-- 로그인 화면 -->
  <div id="loginSection" class="flex flex-col items-center justify-center min-h-screen">
    <div class="max-w-xl w-full bg-white rounded shadow p-6 text-center">
      <h1 class="text-3xl font-bold mb-6">연차 관리 시스템</h1>
      <p class="mb-4 text-gray-600">사용자 유형을 선택하여 로그인하세요.</p>

      <div class="flex flex-col gap-6">
        <!-- 직원 로그인 컨테이너 -->
        <div id="employeeLoginContainer" class="space-y-4">
          <h2 class="text-xl font-semibold text-gray-700">직원 로그인</h2>
          <form id="employeeLoginForm" class="space-y-3">
            <input type="text" id="empLoginName" placeholder="직원 이름" class="w-full border p-3 rounded" required />
            <input type="password" id="empLoginPass" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">로그인</button>
          </form>
          <div class="flex justify-between text-sm">
            <button type="button" id="goToOwnerLogin" onclick="showOwnerLogin()" class="text-blue-600 underline">사업주 로그인</button>
            <!-- 중간 관리자 로그인은 별도 화면을 제공하지 않습니다. -->
          </div>
        </div>
        <!-- 사업주 로그인 컨테이너 -->
        <div id="ownerLoginContainer" class="hidden space-y-4">
          <h2 class="text-xl font-semibold text-gray-700">사업주 로그인</h2>
          <form id="adminLoginForm" class="space-y-3">
            <input type="text" id="adminLoginId" placeholder="아이디" class="w-full border p-3 rounded" required />
            <input type="password" id="adminLoginPass" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">로그인</button>
          </form>
          <div class="flex justify-between items-center text-sm">
            <button type="button" id="goToEmployeeLogin" onclick="showEmployeeLogin()" class="text-blue-600 underline">직원 로그인으로 돌아가기</button>
            <div class="space-x-4">
              <button type="button" onclick="toggleOwnerSubSection('ownerRegisterSection')" class="text-blue-600 underline">사업주 가입</button>
              <button type="button" onclick="toggleOwnerSubSection('resetStep1')" class="text-blue-600 underline">비밀번호 초기화</button>
            </div>
          </div>
          <!-- 사업주 가입 섹션 -->
          <div id="ownerRegisterSection" class="mt-4 hidden">
            <h3 class="text-sm font-semibold mb-2">➕ 사업주 가입하기</h3>
            <form id="registerOwnerForm" class="space-y-3">
              <input type="text" id="newOwnerId" placeholder="신규 아이디" class="w-full p-3 border rounded" required />
              <input type="password" id="newOwnerPass" placeholder="비밀번호" class="w-full p-3 border rounded" required />
              <input type="email" id="newOwnerEmail" placeholder="이메일 주소" class="w-full p-3 border rounded" required />
              <button type="submit" class="w-full bg-gray-700 hover:bg-gray-800 text-white py-2 rounded">가입</button>
            </form>
          </div>
          <!-- 비밀번호 초기화: 단계1 -->
          <div id="resetStep1" class="mt-4 hidden">
            <h3 class="text-sm font-semibold mb-2">비밀번호 초기화 요청</h3>
            <form id="resetRequestForm" class="space-y-3">
              <input type="text" id="resetOwnerId" placeholder="아이디" class="w-full p-3 border rounded" required />
              <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">인증 코드 보내기</button>
            </form>
            <p class="text-xs text-gray-500 mt-2">등록된 이메일로 인증 코드가 전송됩니다.</p>
          </div>
          <!-- 비밀번호 초기화: 단계2 -->
          <div id="resetStep2" class="mt-4 hidden">
            <form id="codeVerifyForm" class="space-y-3">
              <input type="text" id="verifyCode" placeholder="인증 코드 입력" class="w-full p-3 border rounded" required />
              <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded">코드 확인</button>
            </form>
          </div>
          <!-- 비밀번호 초기화: 단계3 -->
          <div id="resetStep3" class="mt-4 hidden">
            <form id="newPasswordForm" class="space-y-3">
              <input type="password" id="newPassword" placeholder="새 비밀번호" class="w-full p-3 border rounded" required />
              <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded">비밀번호 재설정</button>
            </form>
          </div>
        </div>
      </div>


      <p class="text-xs text-gray-400 mt-6">※ LocalStorage 기반으로 작동하며, 브라우저에서 바로 테스트 가능합니다.</p>
    </div>
  </div>

        <!-- 중간 관리자 로그인 컨테이너 -->
        <div id="managerLoginContainer" class="hidden space-y-4">
          <h2 class="text-xl font-semibold text-gray-700">중간 관리자 로그인</h2>
          <form id="managerLoginForm" class="space-y-3">
            <input type="text" id="managerLoginId" placeholder="아이디" class="w-full border p-3 rounded" required />
            <input type="password" id="managerLoginPass" placeholder="비밀번호" class="w-full border p-3 rounded" required />
            <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded">로그인</button>
          </form>
          <div class="flex justify-between text-sm">
            <button type="button" onclick="showEmployeeLogin()" class="text-blue-600 underline">직원 로그인</button>
            <button type="button" onclick="showOwnerLogin()" class="text-blue-600 underline">사업주 로그인</button>
          </div>
        </div>

  <!-- 직원 포털 -->
  <div id="employeePortal" class="hidden">
    <div class="max-w-5xl mx-auto bg-white shadow rounded p-6">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">내 연차 신청</h1>
        <div>
          <span id="employeeInfo" class="text-sm text-gray-600"></span>
          <!-- 페이지 새로고침 버튼 -->
          <!-- Use custom refresh handler to reload only the employee portal while preserving login state -->
          <button onclick="refreshEmployeePortal()" class="ml-4 px-3 py-1 text-sm bg-gray-300 rounded">새로고침</button>
          <button onclick="employeeLogout()" class="ml-2 px-3 py-1 text-sm bg-gray-300 rounded">로그아웃</button>
        </div>
      </div>
      <!-- 직원용 탭 네비게이션 -->
      <div id="empTabs" class="flex gap-4 mb-4">
        <button id="empTabCalendar" type="button" class="emp-tab-btn bg-blue-500 text-white px-3 py-1 rounded">연차 신청</button>
        <button id="empTabList" type="button" class="emp-tab-btn bg-gray-200 text-gray-800 px-3 py-1 rounded">내 연차목록</button>
        <!-- 연차 신청 현황 탭: 중간 관리자 권한이 있는 직원만 표시됨 -->
        <button id="empTabStatus" type="button" class="emp-tab-btn bg-gray-200 text-gray-800 px-3 py-1 rounded hidden">연차 신청 현황</button>
        <button id="empTabDocs" type="button" class="emp-tab-btn bg-gray-200 text-gray-800 px-3 py-1 rounded relative">문서 작성<span id="empDocBadge" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full px-1 hidden"></span></button>
      </div>
      <!-- 연차 신청 및 요약/캘린더 섹션 -->
      <div id="empMainSection">
        <!-- 연차 요약 -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 text-center mb-6 text-sm">
          <div class="bg-blue-100 p-3 rounded"><p>총 연차</p><p class="text-xl font-bold" id="empTotalLeave">0일</p></div>
          <div class="bg-yellow-100 p-3 rounded"><p>승인 대기</p><p class="text-xl font-bold" id="empPendingLeave">0일</p></div>
          <div class="bg-green-100 p-3 rounded"><p>승인 완료</p><p class="text-xl font-bold" id="empApprovedLeave">0일</p></div>
          <div class="bg-gray-200 p-3 rounded"><p>사용 연차</p><p class="text-xl font-bold" id="empUsedLeave">0일</p></div>
          <div class="bg-red-100 p-3 rounded"><p>잔여 연차</p><p class="text-xl font-bold" id="empRemainingLeave">0일</p></div>
        </div>
        <div id="empCalendar"></div>
        <!-- 부서 색상 안내 (직원용) -->
        <div id="empDeptLegend" class="flex flex-wrap gap-2 mt-2 mb-2 text-sm"></div>
        <div class="text-right mt-4">
          <button id="empApplyBtn" class="bg-blue-600 text-white px-4 py-2 rounded">연차 신청</button>
        </div>
      </div><!-- end empMainSection -->
    </div>
    <div id="empFormContainer" class="max-w-2xl mx-auto mt-8 bg-white shadow rounded p-6 hidden">
      <h2 class="text-xl font-semibold mb-4">연차 신청서</h2>
      <form id="empLeaveForm" class="space-y-4">
        <div>
          <label class="block font-medium">선택 날짜 (<span id="empSelectedCount">0</span>일)</label>
          <ul id="empSelectedDatesList" class="list-disc list-inside text-sm text-gray-700"></ul>
        </div>
        <div>
          <label class="block font-medium mb-1">사유</label>
          <textarea id="empReason" class="w-full p-2 border rounded" rows="3" required></textarea>
        </div>
          <!-- 작성 날짜: 신청서를 작성한 날짜를 입력합니다. 기본값은 오늘 날짜로 설정됩니다. -->
          <div>
            <label class="block font-medium mb-1">작성 날짜</label>
            <input id="empSubmissionDate" type="date" class="w-full p-2 border rounded" required />
          </div>
        <div class="flex justify-end gap-2">
          <button type="reset" class="bg-gray-400 text-white px-4 py-2 rounded">취소</button>
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">제출</button>
        </div>
      </form>
    </div>

    <!-- 직원 연차 목록 보기 버튼 제거: 목록은 탭으로 이동했습니다 -->
    <div id="empLeaveListSection" class="max-w-5xl mx-auto mt-4 bg-white shadow rounded p-6 hidden">
      <h2 class="text-xl font-semibold mb-4">내 연차 목록</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <!-- 신청 ID는 가독성을 위해 숨김 -->
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사유</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작성일</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
            </tr>
          </thead>
          <tbody id="empLeaveListTable" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- 직원 문서 제출 섹션: 탭을 통해 표시됩니다 -->
    <div id="empDocSection" class="max-w-5xl mx-auto mt-4 bg-white shadow rounded p-6 hidden">
      <h2 class="text-xl font-semibold mb-4">문서 제출</h2>
      <p id="empDocInfo" class="text-sm text-gray-600 mb-2">요청된 문서가 없습니다.</p>
      <!-- Button to allow employees to create and submit a document without a prior request -->
      <button id="empManualDocBtn" type="button" class="mb-3 bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded" onclick="openEmpManualDocModal()">문서 작성</button>
      <div id="empDocList" class="space-y-4"></div>
    </div>

    <!-- 연차 신청 현황 섹션 (중간 관리자용): 직원 중 권한이 있는 경우에만 표시됩니다 -->
    <div id="empStatusSection" class="max-w-5xl mx-auto mt-4 bg-white shadow rounded p-6 hidden">
      <h2 class="text-xl font-semibold mb-4">연차 신청 현황</h2>
      <!-- 현황 요약 카드: 전체, 대기, 중간 승인, 최종 승인, 반려 건수 -->
      <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 text-center mb-6 text-sm">
        <div class="bg-blue-100 p-3 rounded"><p>전체 신청</p><p class="text-xl font-bold" id="empStatusTotal">0건</p></div>
        <div class="bg-yellow-100 p-3 rounded"><p>대기</p><p class="text-xl font-bold" id="empStatusPending">0건</p></div>
        <div class="bg-green-100 p-3 rounded"><p>중간 승인</p><p class="text-xl font-bold" id="empStatusMgrApproved">0건</p></div>
        <div class="bg-blue-200 p-3 rounded"><p>최종 승인</p><p class="text-xl font-bold" id="empStatusFinalApproved">0건</p></div>
        <div class="bg-red-100 p-3 rounded"><p>반려</p><p class="text-xl font-bold" id="empStatusRejected">0건</p></div>
      </div>
      <div class="text-right mb-2">
        <button id="empMgrBulkApproveBtn" class="bg-green-600 text-white px-4 py-2 rounded">전체 승인</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <!-- 신청 ID는 숨깁니다 -->
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직원</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사유</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">중간 상태</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">최종 상태</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">결재 확인</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">액션</th>
            </tr>
          </thead>
          <tbody id="empMgrRequestTable" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 관리자 포털 -->
  <div id="adminPortal" class="hidden">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold">연차 관리 (관리자)</h1>
        <div class="flex items-center">
          <!-- 페이지 새로고침 버튼 -->
          <!-- Use custom refresh handler to reload only the admin portal while preserving login state -->
          <button onclick="refreshAdminPortal()" class="mr-2 px-3 py-1 text-sm bg-gray-300 rounded">새로고침</button>
          <button onclick="adminLogout()" class="px-3 py-1 text-sm bg-gray-300 rounded">로그아웃</button>
        </div>
      </div>
      <!-- 요약 통계 -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center mb-6 text-sm">
        <div class="bg-yellow-100 p-4 rounded"><p>승인 대기</p><p class="text-xl font-bold" id="admSummaryPending">0건</p></div>
        <div class="bg-green-100 p-4 rounded"><p>승인 완료 (예정)</p><p class="text-xl font-bold" id="admSummaryApproved">0건</p></div>
        <div class="bg-gray-200 p-4 rounded"><p>사용 완료</p><p class="text-xl font-bold" id="admSummaryUsed">0건</p></div>
        <div class="bg-red-100 p-4 rounded"><p>반려</p><p class="text-xl font-bold" id="admSummaryRejected">0건</p></div>
      </div>
      <!-- 탭 버튼 -->
      <div class="flex gap-4 mb-4">
        <button id="tabList" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">연차 목록</button>
        <button id="tabCalendar" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">연차 달력</button>
        <!-- 직원 연차 현황 탭 -->
        <button id="tabEmployeeSummary" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">직원 목록</button>
        <button id="tabEmployees" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">직원 관리</button>
        <button id="tabLeaveDays" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">연차 설정</button>
        <button id="tabSettings" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">사업장 설정</button>
        <button id="tabDocs" class="tab-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">문서 관리</button>
      </div>
      <!-- 연차 목록 섹션 -->
      <div id="admLeaveListSection" class="section">
        <!-- 필터 -->
        <div class="flex flex-wrap items-center gap-4 mb-3">
          <div class="flex items-center gap-2">
            <label for="admEmployeeFilter" class="text-sm font-medium">직원</label>
            <select id="admEmployeeFilter" class="p-2 border rounded text-sm">
              <option value="all">전체</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <label for="admMonthFilter" class="text-sm font-medium">월</label>
            <input id="admMonthFilter" type="month" class="p-2 border rounded text-sm" />
            <button id="admClearMonthFilter" class="px-2 py-1 bg-gray-300 text-sm rounded">초기화</button>
          </div>
        </div>
        <!-- 관리자 전체 승인 버튼 -->
        <div class="text-right mb-2">
          <button id="admBulkApproveBtn" class="bg-green-600 text-white px-4 py-2 rounded">전체 승인</button>
        </div>
        <div class="bg-white shadow rounded overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                <!-- 요청 ID는 숨깁니다 -->
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직원</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">신청 날짜</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사유</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">중간 상태</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">최종 상태</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">결재 확인</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">문서</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">처리</th>
              </tr>
            </thead>
            <tbody id="admRequestsTable" class="bg-white divide-y divide-gray-200">
            </tbody>
          </table>
        </div>
      </div>
      <!-- 연차 달력 섹션 -->
      <div id="admCalendarSection" class="section" style="display:none;">
        <!-- 부서 색상 안내 (관리자용) -->
        <div id="admDeptLegend" class="flex flex-wrap gap-2 mb-2 text-sm"></div>
        <div id="admCalendar" class="bg-white shadow rounded p-4"></div>
      </div>
      <!-- 직원 관리 섹션 -->
      <div id="admEmployeeSection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4">
          <h2 class="text-lg font-semibold mb-3">직원 목록</h2>
          <table class="min-w-full divide-y divide-gray-200 mb-4">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직원 ID</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">부서</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직책</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">입사일</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이메일</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">비밀번호</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">중간권한</th>
                <!-- 직원 관리 테이블에서 총 연차는 연차 설정 탭에서 관리하므로 제거합니다 -->
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">수정</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">삭제</th>
              </tr>
            </thead>
            <tbody id="admEmployeesTable" class="divide-y divide-gray-200"></tbody>
          </table>
          <h3 class="text-md font-semibold mb-2">직원 추가</h3>
          <!-- 직원 추가 폼: 리스트와 맞는 배치로 6열 그리드를 사용합니다 -->
          <form id="admAddEmployeeForm" class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-4">
            <input id="admNewEmpName" type="text" placeholder="이름" class="p-2 border rounded" required />
            <select id="admNewEmpDept" class="p-2 border rounded" required>
              <option value="" disabled selected>부서 선택</option>
            </select>
            <select id="admNewEmpPosition" class="p-2 border rounded" required>
              <option value="" disabled selected>직책 선택</option>
            </select>
            <input id="admNewEmpEntry" type="date" placeholder="입사일" class="p-2 border rounded" required />
            <input id="admNewEmpEmail" type="email" placeholder="이메일" class="p-2 border rounded" required />
            <input id="admNewEmpPass" type="password" placeholder="비밀번호" class="p-2 border rounded" required />
            <!-- 총 연차 입력 필드 제거: 새 직원의 연차는 입사일을 기준으로 자동 계산됩니다 -->
            <div class="md:col-span-6 text-right">
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">추가</button>
            </div>
          </form>

          <!-- 직원 정보 수정 폼 -->
          <div id="editEmployeeFormContainer" class="hidden mt-8">
            <h3 class="text-md font-semibold mb-2">직원 정보 수정</h3>
            <form id="admEditEmployeeForm" class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-4">
              <input id="admEditEmpName" type="text" placeholder="이름" class="p-2 border rounded" required />
              <select id="admEditEmpDept" class="p-2 border rounded" required>
                <option value="" disabled selected>부서 선택</option>
              </select>
              <select id="admEditEmpPosition" class="p-2 border rounded" required>
                <option value="" disabled selected>직책 선택</option>
              </select>
              <input id="admEditEmpEntry" type="date" placeholder="입사일" class="p-2 border rounded" required />
              <input id="admEditEmpEmail" type="email" placeholder="이메일" class="p-2 border rounded" required />
              <input id="admEditEmpPass" type="password" placeholder="비밀번호" class="p-2 border rounded" required />
              <!-- 총 연차는 편집하지 않습니다. 연차는 법정 연차와 조정값으로 계산됩니다. -->
              <div class="md:col-span-6 text-right">
                <button type="button" id="editCancelBtn" class="bg-gray-400 text-white px-4 py-2 rounded mr-2">취소</button>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">저장</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 연차 설정 섹션 -->
      <div id="admLeaveDaysSection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4">
          <h2 class="text-lg font-semibold mb-3">연차 일수 관리</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">입사일</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">연차 기준일</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">다음 갱신</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">법정 연차</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">조정 합계</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">총 연차</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">가감 일수</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사유</th>
                  <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">적용</th>
                </tr>
              </thead>
              <tbody id="leaveDaysTable" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 사업장 설정 섹션: 부서 및 직책 관리 -->
      <div id="admSettingsSection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4 space-y-6">
          <h2 class="text-lg font-semibold mb-2">사업장 설정</h2>
          <!-- 부서 관리 -->
          <div>
            <h3 class="text-md font-semibold mb-2">부서 목록</h3>
            <table class="min-w-full divide-y divide-gray-200 mb-2">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">부서명</th>
                  <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">삭제</th>
                </tr>
              </thead>
              <tbody id="deptList" class="divide-y divide-gray-200"></tbody>
            </table>
            <form id="addDeptForm" class="flex flex-col sm:flex-row gap-2">
              <input id="newDeptName" type="text" placeholder="새 부서명" class="flex-grow p-2 border rounded" required />
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">추가</button>
            </form>
          </div>
          <!-- 직책 관리 -->
          <div>
            <h3 class="text-md font-semibold mb-2">직책 목록</h3>
            <table class="min-w-full divide-y divide-gray-200 mb-2">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직책명</th>
                  <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">삭제</th>
                </tr>
              </thead>
              <tbody id="positionList" class="divide-y divide-gray-200"></tbody>
            </table>
            <form id="addPositionForm" class="flex flex-col sm:flex-row gap-2">
              <input id="newPositionName" type="text" placeholder="새 직책명" class="flex-grow p-2 border rounded" required />
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">추가</button>
            </form>
          </div>

          <!-- 문서 유형 관리 -->
          <div class="mt-6">
            <h3 class="text-md font-semibold mb-2">문서 유형 목록</h3>
            <table class="min-w-full divide-y divide-gray-200 mb-2">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">문서 유형</th>
                  <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">삭제</th>
                </tr>
              </thead>
              <tbody id="docTypeList" class="divide-y divide-gray-200"></tbody>
            </table>
            <form id="addDocTypeForm" class="flex flex-col sm:flex-row gap-2">
              <input id="newDocTypeName" type="text" placeholder="새 문서 유형" class="flex-grow p-2 border rounded" required />
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">추가</button>
            </form>
          </div>

          <!-- 자동 증빙 요청 설정 -->
          <div class="mt-6">
            <h3 class="text-md font-semibold mb-2">연차 신청 자동 증빙 요청</h3>
            <label class="flex items-center text-sm">
              <input id="settingRequirePastProof" type="checkbox" class="mr-2" />
              과거 날짜 연차 신청 시 증빙 요청
            </label>
          </div>
        </div>
      </div>
      <!-- 문서 관리 섹션 -->
      <div id="admDocsSection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4 space-y-4">
          <h2 class="text-lg font-semibold mb-2">문서 관리</h2>
          <!-- 문서 요청 폼 -->
          <form id="admDocRequestForm" class="flex flex-col md:flex-row gap-2 items-end">
            <div class="flex flex-col">
              <label for="admDocEmployee" class="text-sm font-medium mb-1">직원 선택</label>
              <select id="admDocEmployee" class="p-2 border rounded md:min-w-[150px]" required>
                <option value="" disabled selected>직원 선택</option>
              </select>
            </div>
            <div class="flex flex-col">
              <label for="admDocType" class="text-sm font-medium mb-1">문서 유형</label>
              <select id="admDocType" class="p-2 border rounded md:min-w-[150px]" required>
                <option value="" disabled selected>문서 유형</option>
              </select>
            </div>
            <div class="flex flex-col flex-grow">
              <label for="admDocMessage" class="text-sm font-medium mb-1">요청 메시지 (선택)</label>
              <input id="admDocMessage" type="text" class="p-2 border rounded w-full" placeholder="요청 내용" />
            </div>
            <div>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">요청</button>
            </div>
          </form>
          <!-- 문서 요청 목록 필터 -->
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <div class="flex items-center gap-1">
              <label for="admDocFilterEmployee" class="text-sm font-medium">직원</label>
              <select id="admDocFilterEmployee" class="p-2 border rounded text-sm">
                <option value="all">전체</option>
              </select>
            </div>
            <div class="flex items-center gap-1">
              <label for="admDocFilterType" class="text-sm font-medium">문서 유형</label>
              <select id="admDocFilterType" class="p-2 border rounded text-sm">
                <option value="all">전체</option>
              </select>
            </div>
            <button id="admDocFilterReset" class="px-2 py-1 bg-gray-300 text-sm rounded">초기화</button>
          </div>
          <!-- 문서 요청 목록 -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">요청 ID</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직원</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">문서 유형</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">메시지</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">요청일</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제출일</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제출 내용</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제출 파일</th>
                  <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">삭제</th>
                </tr>
              </thead>
              <tbody id="admDocRequestsTable" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>
      </div>
      <!-- 직원 연차 현황 섹션 -->
      <div id="admEmployeeSummarySection" class="section" style="display:none;">
        <div class="bg-white shadow rounded p-4 space-y-4 overflow-x-auto">
          <h2 class="text-lg font-semibold mb-2">직원 목록</h2>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직원 이름</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">부서</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직책</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">총 연차</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사용 연차</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">잔여 연차</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">다음 갱신일</th>
              </tr>
            </thead>
            <tbody id="admEmployeeSummaryTable" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

    <!-- 직원 연차 대시보드 모달 (관리자용) -->
    <div id="admEmployeeDashboardModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
      <div class="bg-white max-w-4xl w-full p-6 rounded shadow relative">
        <!-- Close button -->
        <button onclick="closeAdmEmployeeDashboard()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">X</button>
        <!-- Title -->
        <h2 id="admDashTitle" class="text-xl font-semibold mb-4"></h2>
        <!-- Summary boxes -->
        <div id="admDashSummary" class="grid grid-cols-2 sm:grid-cols-5 gap-4 text-center mb-4 text-sm"></div>
        <!-- Calendar container -->
        <div id="admDashCalendar"></div>
      </div>
    </div>

    <!-- 문서 보기 모달 (관리자용) -->
    <div id="docViewModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
      <div class="bg-white max-w-lg w-full p-6 rounded shadow relative">
        <h2 class="text-xl font-semibold mb-4">문서 보기</h2>
        <div id="docViewContent" class="max-h-96 overflow-auto mb-4"></div>
        <div class="flex justify-end">
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2" onclick="downloadDocPdf()">PDF 다운로드</button>
          <button class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-1 rounded" onclick="closeDocView()">닫기</button>
        </div>
      </div>
    </div>
  </div>

    <!-- 중간 관리자 포털 -->
    <div id="managerPortal" class="hidden">
      <div class="max-w-5xl mx-auto bg-white shadow rounded p-6">
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-2xl font-bold">연차 관리 (중간 관리자)</h1>
          <div class="flex items-center">
            <button onclick="refreshManagerPortal()" class="mr-2 px-3 py-1 text-sm bg-gray-300 rounded">새로고침</button>
            <button onclick="managerLogout()" class="px-3 py-1 text-sm bg-gray-300 rounded">로그아웃</button>
          </div>
        </div>
        <h2 class="text-xl font-semibold mb-4">연차 승인 요청 목록</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">신청 ID</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직원</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사유</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작성일</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">중간 상태</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">최종 상태</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">액션</th>
              </tr>
            </thead>
            <tbody id="mgrRequestTable" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 직원 수동 문서 제출 모달 (문서 요청 없이도 문서 작성) -->
    <div id="empManualDocModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
      <div class="bg-white p-4 rounded shadow max-w-md w-full">
        <h2 class="text-lg font-semibold mb-2">문서 작성</h2>
        <div class="mb-2">
          <label class="block text-sm mb-1">문서 종류</label>
          <select id="empManualDocType" class="w-full p-2 border rounded"></select>
        </div>
        <div class="mb-2">
          <label class="block text-sm mb-1">내용 (선택)</label>
          <textarea id="empManualDocText" rows="3" class="w-full p-2 border rounded"></textarea>
        </div>
        <div class="mb-2">
          <label class="block text-sm mb-1">파일 (선택)</label>
          <input id="empManualDocFile" type="file" class="w-full p-2 border rounded" />
        </div>
        <div class="flex justify-end space-x-2 mt-2">
          <button class="bg-gray-400 text-white px-3 py-1 rounded" onclick="closeEmpManualDocModal()">취소</button>
          <button class="bg-green-600 text-white px-3 py-1 rounded" onclick="submitManualDocument()">제출</button>
        </div>
      </div>
    </div>

    <!-- 서명 그리기 모달 -->
    <!-- This modal provides a drawing canvas for employees to sign their submissions. It is used for leave requests and document submissions. -->
    <div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
      <div class="bg-white p-4 rounded shadow max-w-md w-full">
        <h2 class="text-lg font-semibold mb-2">서명</h2>
        <!-- Canvas for drawing the signature -->
        <canvas id="signatureCanvas" class="border border-gray-400 w-full h-32 mb-2"></canvas>
        <div class="flex justify-end space-x-2 mt-2">
          <button id="sigClearBtn" class="bg-gray-300 px-3 py-1 rounded">지우기</button>
          <button id="sigCancelBtn" class="bg-gray-300 px-3 py-1 rounded">취소</button>
          <button id="sigSaveBtn" class="bg-blue-600 text-white px-3 py-1 rounded">저장</button>
        </div>
      </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <!-- jsPDF library for generating PDFs from HTML -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-9FNCug2EnKQbwFrJNWsLDhQMwfN31oZLHo4m50LFaHxicYTXaOqJwKX6e28Q2xVhkW9me+9hVS6IG9Cvygy0Pg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
// =================================================================
// ===== SUPABASE 클라이언트 설정 (여기를 수정하여 앱과 DB를 연결) =====
// =================================================================

// 1. Supabase 라이브러리 로드 (이 줄은 <script> 태그 바로 아래에 있어야 합니다)
document.write('<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"><\/script>');

// 2. Supabase 접속 정보 설정 (가장 중요!)
// 아래 두 줄의 'YOUR_SUPABASE_URL'과 'YOUR_SUPABASE_ANON_KEY' 부분에
// Supabase 대시보드에서 복사한 당신의 URL과 anon 키를 붙여넣으세요.
const SUPABASE_URL = 'https://chnqtrmlglqdmzqwsazm.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNobnF0cm1sZ2xxZG16cXdzYXptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODUxOTksImV4cCI6MjA3MDA2MTE5OX0.HBvXKoFAQsIjyePoMgtOpYZePoOHO9dYekcAsY1G6gQ';

// 3. Supabase 클라이언트 생성
// 이 'supabase' 객체를 통해 앞으로 모든 DB 작업을 처리합니다.
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// =================================================================
// ===== 기존 코드 수정 시작 (localStorage -> Supabase) =====
// =================================================================

// 예시: 관리자 직원 목록 렌더링 함수 수정
// 이제 이 함수는 localStorage가 아닌 Supabase DB에서 데이터를 가져옵니다.
async function renderAdmEmployees() {
  try {
    // Supabase의 'employees' 테이블에서 모든 데이터를(*) 가져옵니다.
    const { data: employees, error } = await supabase.from('employees').select('*');

    if (error) {
      // 만약 에러가 발생하면 콘솔에 기록하고 사용자에게 알립니다.
      console.error('직원 목록 로딩 실패:', error);
      throw error;
    }

    const tbody = document.getElementById('admEmployeesTable');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    (employees || []).forEach(emp => {
      const tr = document.createElement('tr');
      const mgrLabel = emp.isManager ? '해제' : '권한부여';
      // emp.id 대신 emp.id를 사용합니다 (DB의 id는 숫자형일 수 있음)
      tr.innerHTML = `
        <td class="px-4 py-2 text-sm">${emp.id}</td>
        <td class="px-4 py-2 text-sm">${emp.name || '-'}</td>
        <td class="px-4 py-2 text-sm">${emp.dept || '-'}</td>
        <td class="px-4 py-2 text-sm">${emp.position || '-'}</td>
        <td class="px-4 py-2 text-sm">${emp.entryDate || '-'}</td>
        <td class="px-4 py-2 text-sm">${emp.email || '-'}</td>
        <td class="px-4 py-2 text-sm">${emp.password || '-'}</td>
        <td class="px-4 py-2 text-center text-sm"><button class="text-purple-600" onclick="toggleManagerRole('${emp.id}')">${mgrLabel}</button></td>
        <td class="px-4 py-2 text-center text-sm"><button class="text-blue-600" onclick="showEditEmployee('${emp.id}')">수정</button></td>
        <td class="px-4 py-2 text-center text-sm"><button class="text-red-600" onclick="deleteEmployee('${emp.id}')">삭제</button></td>
      `;
      tbody.appendChild(tr);
    });
    
    // 이 함수는 그대로 둬도 좋습니다. 나중에 필터링 기능도 DB와 연동할 수 있습니다.
    populateAdmEmployeeFilter();

  } catch (err) {
    alert('직원 목록을 불러오는 중 오류가 발생했습니다.');
  }
}

// 중요: 원래 있던 renderAdmEmployees 함수는 이 코드로 완전히 대체됩니다.
// 만약 원래 함수가 있다면 지우고, 이 코드를 붙여넣으세요.



    // Global state
    let currentEmployee = null;
    let empCalendar, admCalendar;

    /**
     * Reload only the employee portal without navigating back to the login page.
     * It reuses the logged-in employee from localStorage and re-initializes
     * the employee UI. If no employee is logged in, it falls back to a full reload
     * which shows the login page.
     */
    window.refreshEmployeePortal = function() {
      const empStr = localStorage.getItem('loggedInEmployee');
      if (empStr) {
        try {
          // parse and set current employee
          currentEmployee = JSON.parse(empStr);
          initializeEmployeePortal();
        } catch (e) {
          // if parsing fails, fallback to full reload
          location.reload();
        }
      } else {
        // no logged-in employee, reload will go to login page
        location.reload();
      }
    };

    /**
     * Reload only the admin portal while preserving the logged-in state.
     * It re-runs initialization functions for the admin UI if an owner
     * is logged in. Otherwise it falls back to a full reload to show
     * the login page.
     */
    window.refreshAdminPortal = function() {
      const ownerStr = localStorage.getItem('loggedInOwner');
      if (ownerStr) {
        try {
          // simply re-initialize the admin portal without parsing owner info
          initializeAdminPortal();
        } catch (e) {
          location.reload();
        }
      } else {
        location.reload();
      }
    };

    // ----------------- Signature pad and modal handling -----------------
    // These variables are defined outside functions to be reused across calls
    let signatureCanvas = null;
    let sigCtx = null;
    let sigDrawing = false;
    let currentSignatureCallback = null;

    /**
     * Initialize the signature canvas and attach drawing event handlers.
     * This function should be called once when the signature modal is first shown.
     */
    function initSignaturePad() {
      if (signatureCanvas) return; // already initialized
      signatureCanvas = document.getElementById('signatureCanvas');
      if (!signatureCanvas) return;
      sigCtx = signatureCanvas.getContext('2d');
      sigCtx.lineWidth = 2;
      sigCtx.lineCap = 'round';
      // Utility to get coordinates from mouse or touch event
      function getPoint(e) {
        const rect = signatureCanvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
          return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        } else {
          return { x: e.offsetX, y: e.offsetY };
        }
      }
      function startDraw(e) {
        e.preventDefault();
        sigDrawing = true;
        const p = getPoint(e);
        sigCtx.beginPath();
        sigCtx.moveTo(p.x, p.y);
      }
      function draw(e) {
        if (!sigDrawing) return;
        e.preventDefault();
        const p = getPoint(e);
        sigCtx.lineTo(p.x, p.y);
        sigCtx.stroke();
      }
      function endDraw(e) {
        sigDrawing = false;
      }
      // Mouse events
      signatureCanvas.addEventListener('mousedown', startDraw);
      signatureCanvas.addEventListener('mousemove', draw);
      signatureCanvas.addEventListener('mouseup', endDraw);
      signatureCanvas.addEventListener('mouseleave', endDraw);
      // Touch events
      signatureCanvas.addEventListener('touchstart', startDraw);
      signatureCanvas.addEventListener('touchmove', draw);
      signatureCanvas.addEventListener('touchend', endDraw);
    }

    /**
     * Show the signature modal and set callback to receive the drawn signature.
     * @param {Function} callback - Function to call with the base64 signature when saved.
     */
    window.showSignatureModal = function(callback) {
      currentSignatureCallback = callback;
      const modal = document.getElementById('signatureModal');
      if (modal) {
        modal.classList.remove('hidden');
      }
      // Ensure signature pad is ready
      initSignaturePad();
      // Clear existing drawing
      if (sigCtx && signatureCanvas) {
        sigCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
      }
    };

    /**
     * Hide the signature modal and reset callback.
     */
    function hideSignatureModal() {
      const modal = document.getElementById('signatureModal');
      if (modal) modal.classList.add('hidden');
      currentSignatureCallback = null;
    }

    // Attach button handlers for signature modal once DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Clear button
      const clearBtn = document.getElementById('sigClearBtn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          if (sigCtx && signatureCanvas) sigCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        });
      }
      // Cancel button
      const cancelBtn = document.getElementById('sigCancelBtn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          hideSignatureModal();
          // If returning to manual document entry, reopen the modal
          if (window._returnToManualDoc) {
            window._returnToManualDoc = false;
            if (typeof openEmpManualDocModal === 'function') {
              openEmpManualDocModal();
            }
          }
        });
      }
      // Save button
      const saveBtn = document.getElementById('sigSaveBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          if (!signatureCanvas) initSignaturePad();
          let data = '';
          try {
            data = signatureCanvas.toDataURL('image/png');
          } catch (e) {
            data = '';
          }
          // Invoke the callback *before* hiding the modal.  The hide function clears
          // currentSignatureCallback, so calling it afterwards would lose the reference.
          if (typeof currentSignatureCallback === 'function') {
            try {
              currentSignatureCallback(data);
            } catch (e) {
              console.error('Error invoking signature callback', e);
            }
          }
          hideSignatureModal();
        });
      }
    });

    // ----------------- Employee Manual Document Submission -----------------
    /**
     * Open the manual document submission modal for employees. Populates the
     * document type dropdown from the stored docTypes and resets fields.
     */
    window.openEmpManualDocModal = function() {
      const modal = document.getElementById('empManualDocModal');
      const typeSel = document.getElementById('empManualDocType');
      if (typeSel) {
        // populate options from docTypes stored in localStorage
        const types = JSON.parse(localStorage.getItem('docTypes') || '[]');
        typeSel.innerHTML = '';
        types.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          typeSel.appendChild(opt);
        });
        if (types.length > 0) {
          // select first type by default
          typeSel.value = types[0];
        }
      }
      // reset other fields
      const textArea = document.getElementById('empManualDocText');
      if (textArea) textArea.value = '';
      const fileInput = document.getElementById('empManualDocFile');
      if (fileInput) fileInput.value = '';
      // Restore draft values if present (e.g., when signature modal was cancelled)
      if (window._manualDocDraft) {
        const draft = window._manualDocDraft;
        if (draft.docType && typeSel) {
          typeSel.value = draft.docType;
        }
        if (draft.text && textArea) {
          textArea.value = draft.text;
        }
        // Once restored, clear the draft
        window._manualDocDraft = null;
      }
      if (modal) modal.classList.remove('hidden');
    };

    /**
     * Close the manual document submission modal.
     */
    window.closeEmpManualDocModal = function() {
      const modal = document.getElementById('empManualDocModal');
      if (modal) modal.classList.add('hidden');
    };

    /**
     * Submit a manually created document from the employee. Captures signature and
     * stores the document in localStorage as a submitted document.
     */
    window.submitManualDocument = function() {
      const typeSel = document.getElementById('empManualDocType');
      const docType = typeSel ? typeSel.value : '';
      if (!docType) {
        alert('문서 종류를 선택해주세요.');
        return;
      }
      const textArea = document.getElementById('empManualDocText');
      const textVal = textArea ? textArea.value.trim() : '';
      const fileInput = document.getElementById('empManualDocFile');
      const file = fileInput && fileInput.files && fileInput.files.length > 0 ? fileInput.files[0] : null;
      // Immediately hide the manual document modal so it does not remain behind the signature overlay
      // Save current draft so it can be restored if the user cancels signing
      window._manualDocDraft = { docType: docType, text: textVal };
      closeEmpManualDocModal();
      // Set a flag indicating that we should return to the manual doc modal if the user cancels the signature
      window._returnToManualDoc = true;
      // Show signature modal and proceed after signature captured
      showSignatureModal(function(sigData) {
        function finalize(fileData, fileName) {
          const docs = JSON.parse(localStorage.getItem('documentRequests') || '[]');
          const newDoc = {
            id: 'doc_' + Date.now(),
            employeeId: currentEmployee.id,
            employeeName: currentEmployee.name,
            type: docType,
            message: '',
            status: 'submitted',
            createdAt: dayjs().format('YYYY-MM-DD'),
            submittedAt: dayjs().format('YYYY-MM-DD'),
            text: textVal || '',
            fileName: fileName || '',
            fileData: fileData || '',
            signature: sigData || ''
          };
          // Generate HTML for admin viewing and PDF
          if (typeof generateDocHtml === 'function') {
            newDoc.docHtml = generateDocHtml(newDoc);
          }
          docs.push(newDoc);
          localStorage.setItem('documentRequests', JSON.stringify(docs));
          documentRequests = docs;
          alert('문서가 제출되었습니다.');
          // The manual document modal has already been closed prior to signature capture
          // Refresh admin documents if available
          if (typeof renderAdminDocs === 'function') renderAdminDocs();
        }
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            finalize(ev.target.result, file.name);
          };
          reader.readAsDataURL(file);
        } else {
          finalize('', '');
        }
      });
    };

    /**
     * 부서 색상 안내를 위한 범례를 업데이트합니다.
     * @param {Object} deptColors - 부서명과 해당 색상의 매핑 객체
     * @param {string} elementId - 범례를 표시할 컨테이너 요소의 ID
     */
    window.updateDeptLegend = function(deptColors, elementId) {
      const container = document.getElementById(elementId);
      if (!container) return;
      container.innerHTML = '';
      const entries = Object.entries(deptColors);
      if (entries.length === 0) {
        // hide legend if no departments
        container.style.display = 'none';
        return;
      }
      container.style.display = 'flex';
      entries.forEach(([dept, color]) => {
        const item = document.createElement('div');
        item.className = 'flex items-center mr-4 mb-1';
        item.innerHTML = `<span style="background-color:${color};width:12px;height:12px;display:inline-block;border-radius:3px;margin-right:4px;"></span><span>${dept}</span>`;
        container.appendChild(item);
      });
    };

    // Document requests: used to manage proof/statement submissions
    // Each item: {id, employeeId, employeeName, type, message, status ('pending'|'submitted'), createdAt, relatedRequestId, submittedAt, text, fileName, fileData}
    let documentRequests = JSON.parse(localStorage.getItem('documentRequests') || '[]');

    // Document types for custom requests (e.g., 연차 증빙, 시말서 등)
    let docTypes = JSON.parse(localStorage.getItem('docTypes') || '[]');
    // Default doc types if none exist
    if (!Array.isArray(docTypes) || docTypes.length === 0) {
      docTypes = ['연차 증빙', '시말서'];
      localStorage.setItem('docTypes', JSON.stringify(docTypes));
    }

    // Settings for automatic behaviours
    let settings = JSON.parse(localStorage.getItem('settings') || '{}');
    if (settings.requirePastDateProof === undefined) {
      // By default, require proof for past date leave
      settings.requirePastDateProof = true;
      localStorage.setItem('settings', JSON.stringify(settings));
    }

    // ----------------- Global lists for departments and positions -----------------
    // Load departments and positions from localStorage, or start with empty arrays
    let departments = JSON.parse(localStorage.getItem('departments') || '[]');
    let positions = JSON.parse(localStorage.getItem('positions') || '[]');

    /**
     * Populate department and position dropdowns in the add/edit employee forms.
     * Ensures that any previously selected value remains selected if it still exists.
     */
    function populateDeptPositionSelects() {
      const deptSelects = [document.getElementById('admNewEmpDept'), document.getElementById('admEditEmpDept')];
      const posSelects = [document.getElementById('admNewEmpPosition'), document.getElementById('admEditEmpPosition')];
      deptSelects.forEach(sel => {
        if (!sel) return;
        const currentVal = sel.value;
        // clear existing options
        sel.innerHTML = '<option value="" disabled selected>부서 선택</option>';
        departments.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sel.appendChild(opt);
        });
        // restore previous value if it still exists
        if (departments.includes(currentVal)) {
          sel.value = currentVal;
        } else {
          sel.value = '';
        }
      });
      posSelects.forEach(sel => {
        if (!sel) return;
        const currentVal = sel.value;
        sel.innerHTML = '<option value="" disabled selected>직책 선택</option>';
        positions.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p;
          opt.textContent = p;
          sel.appendChild(opt);
        });
        if (positions.includes(currentVal)) {
          sel.value = currentVal;
        } else {
          sel.value = '';
        }
      });
    }

    /**
     * Render the department and position lists in the business settings tab.
     * Also updates the dropdowns after rendering.
     */
    function renderSettings() {
      // Refresh lists from localStorage in case they changed elsewhere
      departments = JSON.parse(localStorage.getItem('departments') || '[]');
      positions = JSON.parse(localStorage.getItem('positions') || '[]');
      docTypes = JSON.parse(localStorage.getItem('docTypes') || '[]');
      const deptTbody = document.getElementById('deptList');
      if (deptTbody) {
        deptTbody.innerHTML = '';
        departments.forEach(dept => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="px-3 py-1 text-sm">${dept}</td>
            <td class="px-3 py-1 text-right"><button class="text-red-600" onclick="deleteDept('${dept}')">삭제</button></td>`;
          deptTbody.appendChild(tr);
        });
      }
      const posTbody = document.getElementById('positionList');
      if (posTbody) {
        posTbody.innerHTML = '';
        positions.forEach(pos => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="px-3 py-1 text-sm">${pos}</td>
            <td class="px-3 py-1 text-right"><button class="text-red-600" onclick="deletePosition('${pos}')">삭제</button></td>`;
          posTbody.appendChild(tr);
        });
      }
      // update dropdown options
      populateDeptPositionSelects();

      // Render document types
      const docTbody = document.getElementById('docTypeList');
      if (docTbody) {
        docTbody.innerHTML = '';
        docTypes.forEach(type => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="px-3 py-1 text-sm">${type}</td>
            <td class="px-3 py-1 text-right"><button class="text-red-600" onclick="deleteDocType('${type}')">삭제</button></td>`;
          docTbody.appendChild(tr);
        });
      }
      // Update the auto proof checkbox
      const chk = document.getElementById('settingRequirePastProof');
      if (chk) {
        // ensure settings exist
        settings = JSON.parse(localStorage.getItem('settings') || '{}');
        if (settings.requirePastDateProof === undefined) settings.requirePastDateProof = true;
        chk.checked = !!settings.requirePastDateProof;
      }

      // Also refresh document request dropdowns and filters
      if (typeof populateDocRequestDropdowns === 'function') {
        populateDocRequestDropdowns();
      }
    }

    // Handle submission of new department
    document.getElementById('addDeptForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.getElementById('newDeptName');
      const name = input.value.trim();
      if (!name) return;
      if (departments.includes(name)) {
        alert('이미 존재하는 부서입니다.');
        return;
      }
      departments.push(name);
      localStorage.setItem('departments', JSON.stringify(departments));
      input.value = '';
      renderSettings();
    });

    // Handle submission of new position
    document.getElementById('addPositionForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.getElementById('newPositionName');
      const name = input.value.trim();
      if (!name) return;
      if (positions.includes(name)) {
        alert('이미 존재하는 직책입니다.');
        return;
      }
      positions.push(name);
      localStorage.setItem('positions', JSON.stringify(positions));
      input.value = '';
      renderSettings();
    });

    // Handle submission of new document type
    document.getElementById('addDocTypeForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.getElementById('newDocTypeName');
      const name = input.value.trim();
      if (!name) return;
      if (docTypes.includes(name)) {
        alert('이미 존재하는 문서 유형입니다.');
        return;
      }
      docTypes.push(name);
      localStorage.setItem('docTypes', JSON.stringify(docTypes));
      input.value = '';
      renderSettings();
    });

    // Handle change of auto proof setting
    document.getElementById('settingRequirePastProof')?.addEventListener('change', function(e) {
      settings = JSON.parse(localStorage.getItem('settings') || '{}');
      if (settings.requirePastDateProof === undefined) settings.requirePastDateProof = true;
      settings.requirePastDateProof = this.checked;
      localStorage.setItem('settings', JSON.stringify(settings));
    });

    // Delete department and update employees who belong to it
    window.deleteDept = function(name) {
      departments = departments.filter(d => d !== name);
      localStorage.setItem('departments', JSON.stringify(departments));
      // Update employees: remove department name from any employee using it
      let employees = JSON.parse(localStorage.getItem('employees') || '[]');
      employees.forEach(emp => {
        if (emp.dept === name) {
          emp.dept = '';
        }
      });
      localStorage.setItem('employees', JSON.stringify(employees));
      // Rerender settings and employee list
      renderSettings();
      if (typeof renderAdmEmployees === 'function') renderAdmEmployees();
    };

    // Delete position and update employees who belong to it
    window.deletePosition = function(name) {
      positions = positions.filter(p => p !== name);
      localStorage.setItem('positions', JSON.stringify(positions));
      let employees = JSON.parse(localStorage.getItem('employees') || '[]');
      employees.forEach(emp => {
        if (emp.position === name) {
          emp.position = '';
        }
      });
      localStorage.setItem('employees', JSON.stringify(employees));
      renderSettings();
      if (typeof renderAdmEmployees === 'function') renderAdmEmployees();
    };

    // Delete document type
    window.deleteDocType = function(name) {
      docTypes = docTypes.filter(t => t !== name);
      localStorage.setItem('docTypes', JSON.stringify(docTypes));
      // No need to update employees for doc types
      renderSettings();
    };

    // ----------------- Login Handling -----------------
    // employee login
    document.getElementById('employeeLoginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('empLoginName').value.trim();
      const pass = document.getElementById('empLoginPass').value.trim();
      const employees = JSON.parse(localStorage.getItem('employees') || '[]');
      // 이름과 비밀번호가 모두 일치하는 직원을 찾습니다. 비밀번호가 저장되어 있지 않은 기존 직원의 경우 빈 문자열로 간주합니다.
      const match = employees.find(emp => emp.name === name && ((emp.password || '') === pass));
      if (!match) {
        alert('이름 또는 비밀번호가 올바르지 않습니다.');
        return;
      }
      currentEmployee = match;
      localStorage.setItem('loggedInEmployee', JSON.stringify(match));
      alert(match.name + '님 환영합니다!');
      showEmployeePortal();
    });
    // admin login
    document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('adminLoginId').value.trim();
      const pass = document.getElementById('adminLoginPass').value.trim();
      // admin credentials stored in localStorage.owners (id, password)
      const owners = JSON.parse(localStorage.getItem('owners') || '[]');
      const match = owners.find(o => o.id === id && o.password === pass);
      if (!match) {
        alert('관리자 정보가 일치하지 않습니다.');
        return;
      }
      localStorage.setItem('loggedInOwner', JSON.stringify(match));
      alert(match.id + '님 로그인되었습니다.');
      showAdminPortal();
    });

    // ---------- Owner signup and password reset ----------
    // Initialize EmailJS (for sending reset codes)
    emailjs.init("PblGLG6z-Uk1OO4bR");

    // Owner signup handling
    document.getElementById('registerOwnerForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('newOwnerId').value.trim();
      const pass = document.getElementById('newOwnerPass').value.trim();
      const email = document.getElementById('newOwnerEmail').value.trim();
      if (!id || !pass || !email) {
        alert('아이디, 비밀번호, 이메일을 모두 입력하세요.');
        return;
      }
      let owners = JSON.parse(localStorage.getItem('owners') || '[]');
      if (owners.find(o => o.id === id)) {
        alert('이미 존재하는 아이디입니다.');
        return;
      }
      const newOwner = { id: id, password: pass, email: email };
      owners.push(newOwner);
      localStorage.setItem('owners', JSON.stringify(owners));
      alert('사업주 계정이 등록되었습니다. 로그인해주세요.');
      document.getElementById('registerOwnerForm').reset();
      toggleOwnerSubSection();
    });

    // Function to toggle owner sub sections (signup and password reset forms)
    function toggleOwnerSubSection(section) {
      const sections = ['ownerRegisterSection', 'resetStep1', 'resetStep2', 'resetStep3'];
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
      if (section) {
        const target = document.getElementById(section);
        if (target) target.classList.remove('hidden');
      }
    }

    // 로그인 화면 전환 함수
    // 직원 로그인에서 사업주 로그인 폼으로 전환
    function showOwnerLogin() {
      const empContainer = document.getElementById('employeeLoginContainer');
      const ownerContainer = document.getElementById('ownerLoginContainer');
      const mgrContainer = document.getElementById('managerLoginContainer');
      if (empContainer) empContainer.classList.add('hidden');
      if (ownerContainer) ownerContainer.classList.remove('hidden');
      if (mgrContainer) mgrContainer.classList.add('hidden');
      // 사업주 부가 섹션 초기화 (가입/비밀번호 초기화 폼 감추기)
      toggleOwnerSubSection();
    }
    // 사업주 로그인 폼에서 직원 로그인 폼으로 돌아가기
    function showEmployeeLogin() {
      const empContainer = document.getElementById('employeeLoginContainer');
      const ownerContainer = document.getElementById('ownerLoginContainer');
      const mgrContainer = document.getElementById('managerLoginContainer');
      if (ownerContainer) ownerContainer.classList.add('hidden');
      if (empContainer) empContainer.classList.remove('hidden');
      if (mgrContainer) mgrContainer.classList.add('hidden');
      // 사업주 부가 섹션 초기화
      toggleOwnerSubSection();
    }
    // 중간 관리자 로그인 폼으로 전환
    function showManagerLogin() {
      const empContainer = document.getElementById('employeeLoginContainer');
      const ownerContainer = document.getElementById('ownerLoginContainer');
      const mgrContainer = document.getElementById('managerLoginContainer');
      if (empContainer) empContainer.classList.add('hidden');
      if (ownerContainer) ownerContainer.classList.add('hidden');
      if (mgrContainer) mgrContainer.classList.remove('hidden');
      // Hide any owner sub sections when switching
      toggleOwnerSubSection();
    }

    // Variables used during password reset
    let tempOwnerId = '';
    let sentCode = '';

    // Step1: send verification code to registered email
    document.getElementById('resetRequestForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('resetOwnerId').value.trim();
      if (!id) {
        alert('아이디를 입력하세요.');
        return;
      }
      const owners = JSON.parse(localStorage.getItem('owners') || '[]');
      const owner = owners.find(o => o.id === id);
      if (!owner || !owner.email) {
        alert('해당 아이디의 등록된 이메일을 찾을 수 없습니다.');
        return;
      }
      tempOwnerId = id;
      // generate 4 digit random code
      sentCode = (Math.floor(1000 + Math.random() * 9000)).toString();
      localStorage.setItem('pendingReset_' + id, sentCode);
      // send email via EmailJS; adjust service and template IDs accordingly
      emailjs.send('sunq818', 'template_6c13py3', {
        to_email: owner.email,
        to_name: id,
        reset_code: sentCode
      }).then(function() {
        alert('인증 코드가 등록된 이메일로 전송되었습니다.');
        document.getElementById('resetStep1').classList.add('hidden');
        document.getElementById('resetStep2').classList.remove('hidden');
      }, function(err) {
        alert('이메일 전송 실패: ' + JSON.stringify(err));
      });
    });

    // Step2: verify code
    document.getElementById('codeVerifyForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.getElementById('verifyCode').value.trim();
      const stored = localStorage.getItem('pendingReset_' + tempOwnerId);
      if (input === stored) {
        alert('인증 코드 확인 완료. 새 비밀번호를 입력하세요.');
        document.getElementById('resetStep2').classList.add('hidden');
        document.getElementById('resetStep3').classList.remove('hidden');
      } else {
        alert('코드가 일치하지 않습니다.');
      }
    });

    // Step3: save new password
    document.getElementById('newPasswordForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const newPass = document.getElementById('newPassword').value.trim();
      if (!newPass) {
        alert('새 비밀번호를 입력해주세요.');
        return;
      }
      let owners = JSON.parse(localStorage.getItem('owners') || '[]');
      const targetOwner = owners.find(o => o.id === tempOwnerId);
      if (!targetOwner) {
        alert('계정을 찾을 수 없습니다.');
        return;
      }
      targetOwner.password = newPass;
      localStorage.setItem('owners', JSON.stringify(owners));
      localStorage.removeItem('pendingReset_' + tempOwnerId);
      alert('비밀번호가 재설정되었습니다. 로그인해주세요.');
      document.getElementById('newPasswordForm').reset();
      toggleOwnerSubSection();
    });

    function showEmployeePortal() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('adminPortal').classList.add('hidden');
      // Hide manager portal when switching to employee portal
      const mgrPortalEl = document.getElementById('managerPortal');
      if (mgrPortalEl) mgrPortalEl.classList.add('hidden');
      document.getElementById('employeePortal').classList.remove('hidden');
      initializeEmployeePortal();
    }
    function showAdminPortal() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('employeePortal').classList.add('hidden');
      // Hide manager portal when switching to admin portal
      const mgrPortalEl2 = document.getElementById('managerPortal');
      if (mgrPortalEl2) mgrPortalEl2.classList.add('hidden');
      document.getElementById('adminPortal').classList.remove('hidden');
      initializeAdminPortal();
    }

    // ----------------- Employee Portal -----------------
    function initializeEmployeePortal() {
      // show employee info
      document.getElementById('employeeInfo').textContent = currentEmployee.name + ' (' + (currentEmployee.dept || '-') + ')';
      // Show or hide manager status tab based on employee manager role
      const statusTabBtn = document.getElementById('empTabStatus');
      if (statusTabBtn) {
        if (currentEmployee.isManager) {
          statusTabBtn.classList.remove('hidden');
        } else {
          statusTabBtn.classList.add('hidden');
        }
      }
      // 총 연차는 입사일 기준 법정 연차에 조정값을 더하여 계산합니다.
      function calculateEmpLegal(emp) {
        if (!emp || !emp.entryDate) return 0;
        const entry = dayjs(emp.entryDate);
        const today = dayjs();
        const years = today.diff(entry, 'year', true);
        let legal;
        if (years < 1) {
          const months = today.diff(entry, 'month');
          legal = Math.min(months + 1, 11);
        } else {
          const fullYears = Math.floor(years);
          legal = 15 + Math.floor((fullYears - 1) / 2);
        }
        return legal;
      }
      const legal = calculateEmpLegal(currentEmployee);
      const adjustments = (currentEmployee.adjustments || []).reduce((sum, adj) => sum + adj.amount, 0);
      const totalLeave = legal + adjustments;
      // update currentEmployee.totalLeave for consistency
      currentEmployee.totalLeave = totalLeave;
      document.getElementById('empTotalLeave').textContent = totalLeave + '일';
      // selected dates set
      let selectedDates = new Set();
      function toggleDate(dateStr) {
        selectedDates.has(dateStr) ? selectedDates.delete(dateStr) : selectedDates.add(dateStr);
      }
      function renderSelectedDates() {
        const list = document.getElementById('empSelectedDatesList');
        const count = document.getElementById('empSelectedCount');
        list.innerHTML = '';
        const sorted = Array.from(selectedDates).sort();
        sorted.forEach(date => {
          const li = document.createElement('li');
          li.textContent = date;
          list.appendChild(li);
        });
        count.textContent = sorted.length;
      }
      function calculateEmpSummary() {
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        const today = dayjs();
        let pending = 0, approved = 0, used = 0;
        requests.forEach(req => {
          if (req.employeeId !== currentEmployee.id) return;
          req.dates.forEach(date => {
            const d = dayjs(date);
            if (req.status === 'pending') pending++;
            else if (req.status === 'approved') {
              if (d.isBefore(today, 'day')) used++; else approved++;
            }
          });
        });
        document.getElementById('empPendingLeave').textContent = pending + '일';
        document.getElementById('empApprovedLeave').textContent = approved + '일';
        document.getElementById('empUsedLeave').textContent = used + '일';
        document.getElementById('empRemainingLeave').textContent = (totalLeave - used - approved) + '일';
      }
      // initialize calendar
      const calendarEl = document.getElementById('empCalendar');
      // Prepare events: show all leave requests across employees with department colours and status indicators
      function buildEmpEvents() {
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        const employeesAll = JSON.parse(localStorage.getItem('employees') || '[]');
        // assign colours to departments
        const palette = ['#bbf7d0', '#fecaca', '#fde68a', '#bfdbfe', '#ddd6fe', '#fed7aa', '#fcd34d', '#fbcfe8'];
        const deptColors = {};
        let idx = 0;
        employeesAll.forEach(e => {
          const d = e.dept;
          if (d && !deptColors[d]) {
            deptColors[d] = palette[idx % palette.length];
            idx++;
          }
        });
        const events = [];
        const today = dayjs();
        requests.forEach(req => {
          // determine status colour for signal
          let statusColor;
          if (req.status === 'pending') statusColor = '#facc15'; // yellow
          else if (req.status === 'approved') {
            const endDate = dayjs(req.dates[req.dates.length - 1]);
            statusColor = endDate.isBefore(today, 'day') ? '#a3a3a3' : '#34d399';
          } else if (req.status === 'rejected') statusColor = '#f87171'; // red
          else statusColor = '#a3a3a3';
          const bgColor = deptColors[req.employeeDept] || '#e5e7eb';
          req.dates.forEach(date => {
            events.push({
              title: req.employeeName,
              start: date,
              allDay: true,
              backgroundColor: bgColor,
              borderColor: bgColor,
              textColor: '#000000',
              extendedProps: { statusColor: statusColor }
            });
          });
        });
        // Update the department legend for employees whenever events are built
        if (typeof updateDeptLegend === 'function') {
          updateDeptLegend(deptColors, 'empDeptLegend');
        }
        return events;
      }
      empCalendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        events: buildEmpEvents(),
        eventContent: function(arg) {
          const dotColor = arg.event.extendedProps.statusColor;
          const title = arg.event.title;
          return { html: `<div class="flex items-center"><span style="background-color:${dotColor};width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:4px;"></span><span>${title}</span></div>` };
        },
        dateClick: function(info) {
          toggleDate(info.dateStr);
          info.dayEl.classList.toggle('selected');
          renderSelectedDates();
        }
      });
      empCalendar.render();
      calculateEmpSummary();

      // Helper to refresh calendar events after a new request
      function refreshEmpCalendar() {
        const newEvents = buildEmpEvents();
        empCalendar.removeAllEvents();
        newEvents.forEach(ev => empCalendar.addEvent(ev));
      }

      document.getElementById('empApplyBtn').addEventListener('click', function() {
        if (selectedDates.size === 0) {
          alert('날짜를 선택해주세요.');
          return;
        }
        renderSelectedDates();
        document.getElementById('empFormContainer').classList.remove('hidden');
      });

      document.getElementById('empLeaveForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const reason = document.getElementById('empReason').value.trim();
        if (!reason) {
          alert('사유를 입력해주세요.');
          return;
        }
        const submissionDate = document.getElementById('empSubmissionDate').value;
        if (!submissionDate) {
          alert('작성 날짜를 선택해주세요.');
          return;
        }
        // Determine if a document is required: any selected date before submission date
        const selDates = Array.from(selectedDates).sort();
        const submission = dayjs(submissionDate);
        const needsDoc = selDates.some(d => dayjs(d).isBefore(submission, 'day'));
        // Create leave request object
        const req = {
          id: 'req_' + Date.now(),
          dates: selDates,
          reason: reason,
          // initial status values
          status: 'pending',
          managerStatus: 'pending',
          submittedAt: submissionDate,
          employeeId: currentEmployee.id,
          employeeName: currentEmployee.name,
          employeeDept: currentEmployee.dept || '-'
        };
        // Immediately hide the form before showing signature pad to avoid duplicate popups
        document.getElementById('empFormContainer').classList.add('hidden');
        // Copy the current list of leave requests from storage
        const stored = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        /**
         * Finalize the leave submission once the signature has been captured.
         * We wrap the logic in a try/catch to ensure UI state is restored even if
         * an unexpected error occurs during processing.
         * @param {string} signatureData Base64 image of the signature
         */
        function finalizeLeave(signatureData) {
          try {
            // attach signature to request
            req.signature = signatureData || '';
            // Save leave request
            stored.push(req);
            localStorage.setItem('leaveRequests', JSON.stringify(stored));
            // If a document is required and automatic proof setting is enabled, create a document request for this employee
            if (needsDoc && settings && settings.requirePastDateProof) {
              const docReq = {
                id: 'doc_' + Date.now(),
                employeeId: currentEmployee.id,
                employeeName: currentEmployee.name,
                type: '연차 증빙',
                message: '과거 날짜 연차 신청에 대한 증빙 제출 요청',
                status: 'pending',
                createdAt: submissionDate,
                relatedRequestId: req.id
              };
              documentRequests.push(docReq);
              localStorage.setItem('documentRequests', JSON.stringify(documentRequests));
            }
            // Notify user
            if (needsDoc && settings && settings.requirePastDateProof) {
              alert('연차 신청이 접수되었습니다. 과거 날짜 신청에 대한 증빙 서류 제출 요청이 생성되었습니다. 서류 제출 후 추가 연차 신청이 가능합니다.');
            } else {
              alert('연차 신청 완료!');
            }
          } catch (err) {
            console.error('Error during leave submission:', err);
            alert('연차 신청 처리 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
          } finally {
            // Always reset selections and forms even if an error occurs
            selectedDates.clear();
            document.getElementById('empFormContainer').classList.add('hidden');
            document.getElementById('empLeaveForm').reset();
            // Recalculate and refresh UI components
            if (typeof calculateEmpSummary === 'function') calculateEmpSummary();
            if (typeof refreshEmpCalendar === 'function') refreshEmpCalendar();
            if (typeof renderEmpLeaveList === 'function') renderEmpLeaveList();
            // Update document list and apply button state
            if (typeof renderEmpDocList === 'function') renderEmpDocList();
            if (typeof updateApplyButtonState === 'function') updateApplyButtonState();
          }
        }
        // Show signature modal and proceed after signature is saved
        showSignatureModal(finalizeLeave);
      });

      // Populate submission date default value (today)
      const submissionInput = document.getElementById('empSubmissionDate');
      if (submissionInput) {
        submissionInput.value = dayjs().format('YYYY-MM-DD');
      }

      // 직원 포털 탭 기능
      function showEmpSection(name) {
        const main = document.getElementById('empMainSection');
        const listSec = document.getElementById('empLeaveListSection');
        const docSec = document.getElementById('empDocSection');
        // hide all sections
        if (main) main.classList.add('hidden');
        if (listSec) listSec.classList.add('hidden');
        if (docSec) docSec.classList.add('hidden');
        const statusSec = document.getElementById('empStatusSection');
        if (statusSec) statusSec.classList.add('hidden');
        // reset tab styles
        const tabCalendar = document.getElementById('empTabCalendar');
        const tabList = document.getElementById('empTabList');
        const tabDocs = document.getElementById('empTabDocs');
        const tabStatus = document.getElementById('empTabStatus');
        const tabs = [tabCalendar, tabList, tabDocs, tabStatus];
        tabs.forEach(tab => {
          if (!tab) return;
          tab.classList.remove('bg-blue-500', 'text-white');
          tab.classList.add('bg-gray-200', 'text-gray-800');
        });
        if (name === 'calendar') {
          if (main) main.classList.remove('hidden');
          if (tabCalendar) {
            tabCalendar.classList.remove('bg-gray-200', 'text-gray-800');
            tabCalendar.classList.add('bg-blue-500', 'text-white');
          }
        } else if (name === 'list') {
          if (listSec) {
            listSec.classList.remove('hidden');
            renderEmpLeaveList();
          }
          if (tabList) {
            tabList.classList.remove('bg-gray-200', 'text-gray-800');
            tabList.classList.add('bg-blue-500', 'text-white');
          }
        } else if (name === 'docs') {
          if (docSec) {
            docSec.classList.remove('hidden');
            renderEmpDocList();
          }
          if (tabDocs) {
            tabDocs.classList.remove('bg-gray-200', 'text-gray-800');
            tabDocs.classList.add('bg-blue-500', 'text-white');
          }
        } else if (name === 'status') {
          if (statusSec) {
            statusSec.classList.remove('hidden');
            // Render status requests for manager view
            renderEmpMgrRequests();
          }
          if (tabStatus) {
            tabStatus.classList.remove('bg-gray-200', 'text-gray-800');
            tabStatus.classList.add('bg-blue-500', 'text-white');
          }
        }
      }
      // Attach tab click handlers
      const tabCalendarEl = document.getElementById('empTabCalendar');
      const tabListEl = document.getElementById('empTabList');
      const tabDocsEl = document.getElementById('empTabDocs');
      const tabStatusEl = document.getElementById('empTabStatus');
      if (tabCalendarEl) tabCalendarEl.addEventListener('click', () => showEmpSection('calendar'));
      if (tabListEl) tabListEl.addEventListener('click', () => showEmpSection('list'));
      if (tabDocsEl) tabDocsEl.addEventListener('click', () => showEmpSection('docs'));
      if (tabStatusEl) tabStatusEl.addEventListener('click', () => showEmpSection('status'));

      // Render employee leave list
      function renderEmpLeaveList() {
        const tbody = document.getElementById('empLeaveListTable');
        if (!tbody) return;
        tbody.innerHTML = '';
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        const myReqs = requests.filter(r => r.employeeId === currentEmployee.id);
        // Sort by most recent first
        myReqs.sort((a,b) => Number(b.id.replace('req_','')) - Number(a.id.replace('req_','')));
        myReqs.forEach(req => {
          const tr = document.createElement('tr');
          // Format dates to group same month days together for better readability
          const formattedDates = formatDateList(req.dates || []);
          // Convert status to Korean for display
          let statusKor = '';
          if (req.status === 'pending') statusKor = '대기';
          else if (req.status === 'approved') statusKor = '승인';
          else if (req.status === 'rejected') statusKor = '반려';
          else statusKor = req.status || '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-sm">${formattedDates}</td>
            <td class="px-4 py-2 text-sm">${req.reason}</td>
            <td class="px-4 py-2 text-sm">${req.submittedAt}</td>
            <td class="px-4 py-2 text-sm">${statusKor}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Update apply button based on pending document requests
      function updateApplyButtonState() {
        const applyBtn = document.getElementById('empApplyBtn');
        // reload document requests from localStorage each time to ensure latest state
        const docs = JSON.parse(localStorage.getItem('documentRequests') || '[]');
        const pendingDocs = docs.filter(doc => doc.employeeId === currentEmployee.id && doc.status === 'pending');
        if (pendingDocs.length > 0) {
          // disable apply button when there are pending docs
          applyBtn.disabled = true;
          applyBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
          applyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
          applyBtn.textContent = '문서 제출 필요';
        } else {
          applyBtn.disabled = false;
          applyBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
          applyBtn.classList.add('bg-blue-600');
          applyBtn.textContent = '연차 신청';
        }
        // Update document badge on doc tab
        updateEmpDocBadge();
      }

      // Render the list of pending document requests for the employee
      function renderEmpDocList() {
        const listContainer = document.getElementById('empDocList');
        const infoText = document.getElementById('empDocInfo');
        if (!listContainer || !infoText) return;
        listContainer.innerHTML = '';
        // reload document requests from localStorage for latest state
        const docs = JSON.parse(localStorage.getItem('documentRequests') || '[]');
        const myDocs = docs.filter(doc => doc.employeeId === currentEmployee.id && doc.status === 'pending');
        if (myDocs.length === 0) {
          infoText.textContent = '요청된 문서가 없습니다.';
        } else {
          infoText.textContent = '아래 요청된 문서를 작성하여 제출해주세요.';
        }
        myDocs.forEach(doc => {
          const div = document.createElement('div');
          div.className = 'border p-4 rounded';
          // Card with summary and a toggle button to reveal the form
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <p class="font-medium mb-1">요청 유형: ${doc.type}</p>
                <p class="text-sm">요청 내용: ${doc.message || ''}</p>
                <p class="text-xs text-gray-500">요청일: ${doc.createdAt || ''}</p>
              </div>
              <button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="toggleDocForm('${doc.id}')">문서 작성</button>
            </div>
            <div id="docForm_${doc.id}" class="mt-2 hidden">
              <textarea id="docText_${doc.id}" rows="3" class="w-full p-2 border rounded mb-2" placeholder="내용(선택)"></textarea>
              <input id="docFile_${doc.id}" type="file" class="w-full p-2 border rounded mb-2" />
              <div class="text-right">
                <button class="bg-green-600 text-white px-3 py-1 rounded mr-2" onclick="submitDocument('${doc.id}')">제출</button>
                <button class="bg-gray-400 text-white px-3 py-1 rounded" onclick="toggleDocForm('${doc.id}')">취소</button>
              </div>
            </div>
          `;
          listContainer.appendChild(div);
        });
      }

    // Update document badge indicator on the doc tab
    function updateEmpDocBadge() {
      const badge = document.getElementById('empDocBadge');
      if (!badge || !currentEmployee) return;
      const docs = JSON.parse(localStorage.getItem('documentRequests') || '[]');
      const pending = docs.filter(doc => doc.employeeId === currentEmployee.id && doc.status === 'pending');
      if (pending.length > 0) {
        // Show count if more than one, otherwise exclamation mark
        badge.textContent = pending.length > 1 ? String(pending.length) : '!';
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    /* =======================
       Manager (Middle approval) functions for employees with manager role
       These functions allow manager-designated employees to view all leave requests,
       approve or reject them, and perform bulk approvals. They also update summary
       cards showing counts of each state.
    ======================= */
    // Render the manager overview table and summary
    function renderEmpMgrRequests() {
      const tbody = document.getElementById('empMgrRequestTable');
      if (!tbody) return;
      tbody.innerHTML = '';
      let total = 0, pending = 0, mgrApproved = 0, finalApproved = 0, rejected = 0;
      let requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
      // Sort by most recent id (timestamp) descending so the latest requests appear first
      requests = requests.slice().sort((a,b) => {
        const at = Number(String(a.id || '').replace('req_','')) || 0;
        const bt = Number(String(b.id || '').replace('req_','')) || 0;
        return bt - at;
      });
      requests.forEach(req => {
        total++;
        // count based on status
        if (req.status === 'pending') {
          if (req.managerStatus === 'approved') mgrApproved++; else pending++;
        } else if (req.status === 'approved') {
          finalApproved++;
        } else if (req.status === 'rejected') {
          rejected++;
        }
        const mgrStatus = req.managerStatus || 'pending';
        const finalStatus = req.status;
        // Convert statuses to Korean labels
        let mgrStatusDisp = '';
        if (mgrStatus === 'approved') mgrStatusDisp = '승인';
        else if (mgrStatus === 'rejected') mgrStatusDisp = '반려';
        else if (mgrStatus === 'skipped') mgrStatusDisp = '없음';
        else mgrStatusDisp = '대기';
        let finalStatusDisp = '';
        if (finalStatus === 'approved') finalStatusDisp = '승인';
        else if (finalStatus === 'rejected') finalStatusDisp = '반려';
        else if (finalStatus === 'pending') finalStatusDisp = '대기';
        else finalStatusDisp = finalStatus || '';
        const approvalCheck = finalStatus === 'pending' ? '미결' : '완료';
        let actions = '-';
        if (finalStatus === 'pending') {
          if (mgrStatus === 'pending') {
            actions = `<button class="text-green-600 mr-2" onclick="empMgrApproveRequest('${req.id}')">승인</button>` +
                      `<button class="text-red-600" onclick="empMgrRejectRequest('${req.id}')">반려</button>`;
          } else {
            actions = '-';
          }
        }
        const tr = document.createElement('tr');
        // Format the date list for better readability
        const formattedDates = formatDateList(req.dates || []);
        tr.innerHTML = `
          <td class="px-4 py-2 text-sm">${req.employeeName}</td>
          <td class="px-4 py-2 text-sm">${formattedDates}</td>
          <td class="px-4 py-2 text-sm">${req.reason || ''}</td>
          <td class="px-4 py-2 text-sm">${mgrStatusDisp}</td>
          <td class="px-4 py-2 text-sm">${finalStatusDisp}</td>
          <td class="px-4 py-2 text-sm">${approvalCheck}</td>
          <td class="px-4 py-2 text-center text-sm">${actions}</td>
        `;
        tbody.appendChild(tr);
      });
      // update summary
      const totalEl = document.getElementById('empStatusTotal');
      const pendingEl = document.getElementById('empStatusPending');
      const mgrEl = document.getElementById('empStatusMgrApproved');
      const finalEl = document.getElementById('empStatusFinalApproved');
      const rejEl = document.getElementById('empStatusRejected');
      if (totalEl) totalEl.textContent = total + '건';
      if (pendingEl) pendingEl.textContent = pending + '건';
      if (mgrEl) mgrEl.textContent = mgrApproved + '건';
      if (finalEl) finalEl.textContent = finalApproved + '건';
      if (rejEl) rejEl.textContent = rejected + '건';
    }

    // Approve request as manager
    window.empMgrApproveRequest = function(reqId) {
      let requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
      const idx = requests.findIndex(r => r.id === reqId);
      if (idx === -1) return;
      if (requests[idx].status !== 'pending') {
        alert('이미 최종 결재가 완료되었습니다.');
        return;
      }
      requests[idx].managerStatus = 'approved';
      localStorage.setItem('leaveRequests', JSON.stringify(requests));
      alert('승인 처리되었습니다.');
      renderEmpMgrRequests();
      // update admin views
      if (typeof renderAdmRequestTable === 'function') {
        renderAdmRequestTable();
        renderAdmCalendar();
        if (typeof renderAdmSummary === 'function') renderAdmSummary(JSON.parse(localStorage.getItem('leaveRequests') || '[]'));
      }
    };

    // Reject request as manager
    window.empMgrRejectRequest = function(reqId) {
      let requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
      const idx = requests.findIndex(r => r.id === reqId);
      if (idx === -1) return;
      if (requests[idx].status !== 'pending') {
        alert('이미 최종 결재가 완료되었습니다.');
        return;
      }
      requests[idx].managerStatus = 'rejected';
      localStorage.setItem('leaveRequests', JSON.stringify(requests));
      alert('반려 처리되었습니다.');
      renderEmpMgrRequests();
      if (typeof renderAdmRequestTable === 'function') {
        renderAdmRequestTable();
        renderAdmCalendar();
        if (typeof renderAdmSummary === 'function') renderAdmSummary(JSON.parse(localStorage.getItem('leaveRequests') || '[]'));
      }
    };

    // Bulk approve all pending manager requests
    const mgrBulkBtn = document.getElementById('empMgrBulkApproveBtn');
    if (mgrBulkBtn) {
      mgrBulkBtn.addEventListener('click', function() {
        let requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        let changed = false;
        requests.forEach(req => {
          if (req.status === 'pending' && (req.managerStatus || 'pending') === 'pending') {
            req.managerStatus = 'approved';
            changed = true;
          }
        });
        if (changed) {
          localStorage.setItem('leaveRequests', JSON.stringify(requests));
          alert('전체 승인되었습니다.');
        } else {
          alert('승인할 신청이 없습니다.');
        }
        renderEmpMgrRequests();
        if (typeof renderAdmRequestTable === 'function') {
          renderAdmRequestTable();
          renderAdmCalendar();
          if (typeof renderAdmSummary === 'function') renderAdmSummary(JSON.parse(localStorage.getItem('leaveRequests') || '[]'));
        }
      });
    }

      // 문서 제출 탭은 따로 처리하므로 토글 버튼 이벤트는 제거되었습니다.

      // Initial update of apply button state, document badge and document list
      updateApplyButtonState();
      // ensure badge is set on load
      if (typeof updateEmpDocBadge === 'function') updateEmpDocBadge();
      // Show calendar section by default on load
      if (typeof showEmpSection === 'function') showEmpSection('calendar');

      // Expose doc helper functions globally so submitDocument can call them
      window.renderEmpDocList = renderEmpDocList;
      window.updateApplyButtonState = updateApplyButtonState;

      // Toggle visibility of document input form inside employee doc list
      window.toggleDocForm = function(id) {
        const form = document.getElementById('docForm_' + id);
        if (form) {
          if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
          } else {
            form.classList.add('hidden');
          }
        }
      };

      // Alert on login if there are pending document requests
      setTimeout(() => {
        const docs = JSON.parse(localStorage.getItem('documentRequests') || '[]');
        const pending = docs.filter(doc => doc.employeeId === currentEmployee.id && doc.status === 'pending');
        if (pending.length > 0) {
          alert('제출해야 할 문서가 있습니다. 문서 제출 후 연차 신청이 가능합니다.');
        }
      }, 100);
    }

    function employeeLogout() {
      localStorage.removeItem('loggedInEmployee');
      currentEmployee = null;
      // reload to login
      location.reload();
    }

    // ----------------- Admin Portal -----------------
    function initializeAdminPortal() {
      // Lists of departments and positions are loaded globally (departments, positions)
      // They are kept in sync with localStorage via renderSettings() and related functions.

      // Tab handling
      const tabButtons = {
        list: document.getElementById('tabList'),
        calendar: document.getElementById('tabCalendar'),
        employeeSummary: document.getElementById('tabEmployeeSummary'),
        employees: document.getElementById('tabEmployees'),
        leaveDays: document.getElementById('tabLeaveDays'),
        settings: document.getElementById('tabSettings'),
        docs: document.getElementById('tabDocs')
      };
      const sections = {
        list: document.getElementById('admLeaveListSection'),
        calendar: document.getElementById('admCalendarSection'),
        employeeSummary: document.getElementById('admEmployeeSummarySection'),
        employees: document.getElementById('admEmployeeSection'),
        leaveDays: document.getElementById('admLeaveDaysSection'),
        settings: document.getElementById('admSettingsSection'),
        docs: document.getElementById('admDocsSection')
      };
      function showAdminSection(name) {
        for (const key in sections) {
          sections[key].style.display = key === name ? 'block' : 'none';
        }
      }
      tabButtons.list.onclick = () => showAdminSection('list');
      tabButtons.calendar.onclick = () => {
        showAdminSection('calendar');
        renderAdmCalendar();
      };
      tabButtons.employees.onclick = () => showAdminSection('employees');
      tabButtons.leaveDays.onclick = () => {
        showAdminSection('leaveDays');
        renderLeaveDays();
      };
      tabButtons.settings.onclick = () => {
        showAdminSection('settings');
        renderSettings();
      };
      // New tab: document management
      if (tabButtons.docs) {
        tabButtons.docs.onclick = () => {
          showAdminSection('docs');
          // Populate dropdowns before showing
          populateDocRequestDropdowns();
          // Render document request list
          renderAdminDocs();
        };
      }
      // New tab: employee summary (연차 사용 현황)
      if (tabButtons.employeeSummary) {
        tabButtons.employeeSummary.onclick = () => {
          showAdminSection('employeeSummary');
          renderAdmEmployeeSummary();
        };
      }

      // Populate initial department/position dropdowns and render settings list on admin load
      populateDeptPositionSelects();
      renderSettings();

      // Summary, employee filter, list rendering, etc.
      function updateAdmSummary(data) {
        let pending = 0, approved = 0, used = 0, rejected = 0;
        const today = dayjs();
        data.forEach(req => {
          if (req.status === 'pending') pending++;
          else if (req.status === 'approved') {
            const endDate = dayjs(req.dates[req.dates.length - 1]);
            if (endDate.isBefore(today, 'day')) used++; else approved++;
          } else if (req.status === 'rejected') rejected++;
        });
        document.getElementById('admSummaryPending').textContent = pending + '건';
        document.getElementById('admSummaryApproved').textContent = approved + '건';
        document.getElementById('admSummaryUsed').textContent = used + '건';
        document.getElementById('admSummaryRejected').textContent = rejected + '건';
      }
      function populateAdmEmployeeFilter() {
        const select = document.getElementById('admEmployeeFilter');
        const currentValue = select.value || 'all';
        select.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = 'all';
        optAll.textContent = '전체';
        select.appendChild(optAll);
        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
        employees.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.name;
          select.appendChild(opt);
        });
        select.value = currentValue;
      }
      function renderAdmRequestTable() {
        const tbody = document.getElementById('admRequestsTable');
        tbody.innerHTML = '';
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        // load document requests to display status
        documentRequests = JSON.parse(localStorage.getItem('documentRequests') || '[]');
        const employeeFilter = document.getElementById('admEmployeeFilter').value;
        const monthFilter = document.getElementById('admMonthFilter').value;
        const filtered = requests.filter(req => {
          if (employeeFilter !== 'all' && req.employeeId !== employeeFilter) return false;
          if (monthFilter) {
            const reqMonth = req.dates && req.dates.length > 0 ? req.dates[0].slice(0, 7) : '';
            if (reqMonth !== monthFilter) return false;
          }
          return true;
        });
        // sort by most recent submittedAt or id timestamp descending
        const sorted = filtered.slice().sort((a,b) => {
          // use id timestamp part if available
          const aTime = Number(a.id.replace('req_',''));
          const bTime = Number(b.id.replace('req_',''));
          return bTime - aTime;
        });
        sorted.forEach(req => {
          const tr = document.createElement('tr');
          // employee name is clickable to view dashboard and show signature if available
          const sigImg = req.signature ? `<img src="${req.signature}" style="height:20px; margin-left:4px; display:inline;" />` : '';
          const nameCell = `<button class="text-blue-600 underline" onclick="viewEmployeeDashboard('${req.employeeId}')">${req.employeeName}</button>${sigImg}`;
          // Find associated document request if any
          const doc = documentRequests.find(d => d.relatedRequestId === req.id);
          let docStatus = '-';
          if (doc) {
            docStatus = (doc.status === 'pending' ? '요청중' : '제출됨');
          }
          // actions: owner can approve/reject for pending final status
          let actions = '';
          if (req.status === 'pending') {
            actions += `<button class="text-green-600 mr-2" onclick="approveRequest('${req.id}')">승인</button>`;
            actions += `<button class="text-red-600 mr-2" onclick="rejectRequest('${req.id}')">반려</button>`;
          }
          // allow document request if none exists
          if (!doc) {
            actions += `<button class="text-purple-600 mr-2" onclick="requestDoc('${req.id}')">서류 요청</button>`;
          }
          actions += `<button class="text-gray-600" onclick="deleteRequest('${req.id}')">삭제</button>`;
          const mgrStatus = req.managerStatus || 'pending';
          const finalStatus = req.status;
          // Convert final status to Korean
          let finalStatusDisp = '';
          if (finalStatus === 'approved') finalStatusDisp = '승인';
          else if (finalStatus === 'rejected') finalStatusDisp = '반려';
          else if (finalStatus === 'pending') finalStatusDisp = '대기';
          else finalStatusDisp = finalStatus || '';
          // Friendly label for manager status
          let mgrStatusDisp = '';
          if (mgrStatus === 'approved') mgrStatusDisp = '승인';
          else if (mgrStatus === 'rejected') mgrStatusDisp = '반려';
          else if (mgrStatus === 'skipped') mgrStatusDisp = '없음';
          else mgrStatusDisp = '대기';
          // 결재 확인: finalStatus가 pending이 아니면 '완료', pending이면 '미결'
          const approvalCheck = finalStatus === 'pending' ? '미결' : '완료';
          // Format dates for better readability (group same month days)
          const formattedDatesAdm = formatDateList(req.dates || []);
          tr.innerHTML = `
            <td class="px-4 py-2 text-sm">${nameCell}</td>
            <td class="px-4 py-2 text-sm">${formattedDatesAdm}</td>
            <td class="px-4 py-2 text-sm">${req.reason}</td>
            <td class="px-4 py-2 text-sm">${mgrStatusDisp}</td>
            <td class="px-4 py-2 text-sm">${finalStatusDisp}</td>
            <td class="px-4 py-2 text-sm">${approvalCheck}</td>
            <td class="px-4 py-2 text-sm">${docStatus}</td>
            <td class="px-4 py-2 text-center text-sm">${actions}</td>
          `;
          tbody.appendChild(tr);
        });
        updateAdmSummary(requests);
      }
      document.getElementById('admEmployeeFilter').addEventListener('change', renderAdmRequestTable);
      document.getElementById('admMonthFilter').addEventListener('change', renderAdmRequestTable);
      document.getElementById('admClearMonthFilter').addEventListener('click', function() {
        document.getElementById('admMonthFilter').value = '';
        renderAdmRequestTable();
      });

      // Bulk approve all pending leave requests in admin view
      const adminBulkBtn = document.getElementById('admBulkApproveBtn');
      if (adminBulkBtn) {
        adminBulkBtn.addEventListener('click', function() {
          let requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
          let changed = false;
          requests.forEach(req => {
            if (req.status === 'pending') {
              req.status = 'approved';
              // If manager approval still pending, mark as skipped
              if (req.managerStatus === undefined || req.managerStatus === 'pending') {
                req.managerStatus = 'skipped';
              }
              changed = true;
            }
          });
          if (changed) {
            localStorage.setItem('leaveRequests', JSON.stringify(requests));
            alert('전체 신청이 승인되었습니다.');
          } else {
            alert('승인할 신청이 없습니다.');
          }
          renderAdmRequestTable();
          renderAdmCalendar();
          if (typeof renderAdmSummary === 'function') renderAdmSummary(JSON.parse(localStorage.getItem('leaveRequests') || '[]'));
        });
      }
      // Approve / Reject functions
      window.approveRequest = function(id) {
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        const idx = requests.findIndex(r => r.id === id);
        if (idx === -1) return;
        // If manager approval is still pending, mark it as skipped (owner approval overrides)
        if (requests[idx].managerStatus === undefined || requests[idx].managerStatus === 'pending') {
          requests[idx].managerStatus = 'skipped';
        }
        requests[idx].status = 'approved';
        localStorage.setItem('leaveRequests', JSON.stringify(requests));
        alert('승인되었습니다.');
        renderAdmRequestTable();
        renderAdmCalendar();
      };
      window.rejectRequest = function(id) {
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        const idx = requests.findIndex(r => r.id === id);
        if (idx === -1) return;
        // If manager approval is still pending, mark it as skipped (owner rejection overrides)
        if (requests[idx].managerStatus === undefined || requests[idx].managerStatus === 'pending') {
          requests[idx].managerStatus = 'skipped';
        }
        requests[idx].status = 'rejected';
        localStorage.setItem('leaveRequests', JSON.stringify(requests));
        alert('반려되었습니다.');
        renderAdmRequestTable();
        renderAdmCalendar();
      };

      // Delete leave request
      window.deleteRequest = function(id) {
        let requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        requests = requests.filter(r => r.id !== id);
        localStorage.setItem('leaveRequests', JSON.stringify(requests));
        alert('연차 신청이 삭제되었습니다.');
        renderAdmRequestTable();
        renderAdmCalendar();
      };

      // Request document from employee for a specific leave request
      window.requestDoc = function(reqId) {
        // reload requests and documentRequests to ensure fresh state
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        let docs = JSON.parse(localStorage.getItem('documentRequests') || '[]');
        const targetReq = requests.find(r => r.id === reqId);
        if (!targetReq) return;
        // Prevent duplicate doc request
        if (docs.find(d => d.relatedRequestId === reqId)) {
          alert('이미 문서 요청이 생성되어 있습니다.');
          return;
        }
        // Suggest available document types
        const type = prompt('요청할 문서 종류를 입력하세요 (예: 증빙, 시말서 등). 가능한 유형: ' + (docTypes.join(', ') || '없음'), docTypes[0] || '');
        if (!type) return;
        const message = prompt('요청 메시지를 입력하세요 (선택)', '') || '';
        const newDoc = {
          id: 'doc_' + Date.now(),
          employeeId: targetReq.employeeId,
          employeeName: targetReq.employeeName,
          type: type,
          message: message,
          status: 'pending',
          createdAt: dayjs().format('YYYY-MM-DD'),
          relatedRequestId: reqId
        };
        docs.push(newDoc);
        localStorage.setItem('documentRequests', JSON.stringify(docs));
        // update global
        documentRequests = docs;
        alert('문서 요청이 생성되었습니다.');
        renderAdmRequestTable();
      };
      // Calendar rendering for admin
      function renderAdmCalendar() {
        const el = document.getElementById('admCalendar');
        if (!el) return;
        if (admCalendar) admCalendar.destroy();
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
        // Assign a unique color to each department (rotating through palette)
        const palette = ['#bbf7d0', '#fecaca', '#fde68a', '#bfdbfe', '#ddd6fe', '#fed7aa', '#fcd34d', '#fbcfe8'];
        const deptColors = {};
        let colorIndex = 0;
        employees.forEach(emp => {
          const dept = emp.dept;
          if (dept && !deptColors[dept]) {
            deptColors[dept] = palette[colorIndex % palette.length];
            colorIndex++;
          }
        });
        const events = [];
        const today = dayjs();
        requests.forEach(req => {
          // Determine status colour for indicator
          let statusColor;
          if (req.status === 'pending') statusColor = '#facc15';
          else if (req.status === 'approved') {
            const endDate = dayjs(req.dates[req.dates.length - 1]);
            statusColor = endDate.isBefore(today, 'day') ? '#a3a3a3' : '#34d399';
          } else if (req.status === 'rejected') statusColor = '#f87171';
          else statusColor = '#a3a3a3';
          const bgColor = deptColors[req.employeeDept] || '#e5e7eb'; // default gray if no dept
          req.dates.forEach(date => {
            events.push({
              title: req.employeeName,
              start: date,
              allDay: true,
              backgroundColor: bgColor,
              borderColor: bgColor,
              textColor: '#000000',
              extendedProps: { statusColor: statusColor }
            });
          });
        });
        // Update department legend for admin calendar
        if (typeof updateDeptLegend === 'function') {
          updateDeptLegend(deptColors, 'admDeptLegend');
        }
        admCalendar = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          locale: 'ko',
          events: events,
          eventContent: function(arg) {
            const dotColor = arg.event.extendedProps.statusColor;
            const title = arg.event.title;
            return { html: `<div class="flex items-center"><span style="background-color:${dotColor};width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:4px;"></span><span>${title}</span></div>` };
          }
        });
        admCalendar.render();
      }
      // Employee management
      function renderAdmEmployees() {
        const tbody = document.getElementById('admEmployeesTable');
        tbody.innerHTML = '';
        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
        employees.forEach(emp => {
          const tr = document.createElement('tr');
          const mgrLabel = emp.isManager ? '해제' : '권한부여';
          tr.innerHTML = `
            <td class="px-4 py-2 text-sm">${emp.id}</td>
            <td class="px-4 py-2 text-sm">${emp.name || '-'}</td>
            <td class="px-4 py-2 text-sm">${emp.dept || '-'}</td>
            <td class="px-4 py-2 text-sm">${emp.position || '-'}</td>
            <td class="px-4 py-2 text-sm">${emp.entryDate || '-'}</td>
            <td class="px-4 py-2 text-sm">${emp.email || '-'}</td>
            <td class="px-4 py-2 text-sm">${emp.password || '-'}</td>
            <td class="px-4 py-2 text-center text-sm"><button class="text-purple-600" onclick="toggleManagerRole('${emp.id}')">${mgrLabel}</button></td>
            <td class="px-4 py-2 text-center text-sm"><button class="text-blue-600" onclick="showEditEmployee('${emp.id}')">수정</button></td>
            <td class="px-4 py-2 text-center text-sm"><button class="text-red-600" onclick="deleteEmployee('${emp.id}')">삭제</button></td>
          `;
          tbody.appendChild(tr);
        });
        populateAdmEmployeeFilter();
      }
      window.deleteEmployee = function(id) {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        employees = employees.filter(e => e.id !== id);
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('삭제되었습니다.');
        renderAdmEmployees();
        populateAdmEmployeeFilter();
        renderAdmRequestTable();
        renderAdmCalendar();
      };

      /**
       * Toggle manager role for an employee. This allows the owner to designate or
       * remove middle-approval permissions for a staff member. When toggled,
       * the employee will see the 신청 현황 tab in their portal if granted.
       *
       * @param {string} empId Employee ID
       */
      window.toggleManagerRole = function(empId) {
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        const idx = employees.findIndex(e => e.id === empId);
        if (idx === -1) return;
        const newVal = !employees[idx].isManager;
        employees[idx].isManager = newVal;
        localStorage.setItem('employees', JSON.stringify(employees));
        alert(newVal ? '중간 관리자 권한이 부여되었습니다.' : '중간 관리자 권한이 해제되었습니다.');
        renderAdmEmployees();
        populateAdmEmployeeFilter();
      };
      document.getElementById('admAddEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('admNewEmpName').value.trim();
        const dept = document.getElementById('admNewEmpDept').value.trim();
        const position = document.getElementById('admNewEmpPosition').value.trim();
        const entryDate = document.getElementById('admNewEmpEntry').value;
        const email = document.getElementById('admNewEmpEmail').value.trim();
        const pass = document.getElementById('admNewEmpPass').value.trim();
        // 총 연차는 입력하지 않으며, 입사일 기준으로 계산합니다.
        // 모든 필드를 입력해야 합니다. 입력하지 않은 값이 있으면 추가를 막습니다.
        if (!name || !dept || !position || !entryDate || !email || !pass) {
          alert('모든 필드를 입력해주세요.');
          return;
        }
        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
        const newEmp = {
          id: 'emp_' + Date.now(),
          name: name,
          dept: dept,
          position: position,
          entryDate: entryDate,
          email: email,
          password: pass,
          adjustments: []
        };
        // 초기 법정 연차를 계산하여 총 연차에 저장
        const initialLegal = calculateLegalLeave(newEmp);
        newEmp.totalLeave = initialLegal;
        employees.push(newEmp);
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('직원 추가 완료');
        document.getElementById('admAddEmployeeForm').reset();
        renderAdmEmployees();
        populateAdmEmployeeFilter();
      });

      // ----- 직원 정보 수정 기능 -----
      let editingEmpId = null;
      window.showEditEmployee = function(id) {
        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
        const emp = employees.find(e => e.id === id);
        if (!emp) return;
        editingEmpId = id;
        // Dropdowns should reflect the latest department/position lists
        populateDeptPositionSelects();
        // 채우기
        document.getElementById('admEditEmpName').value = emp.name || '';
        document.getElementById('admEditEmpDept').value = emp.dept || '';
        document.getElementById('admEditEmpPosition').value = emp.position || '';
        document.getElementById('admEditEmpEntry').value = emp.entryDate || '';
        document.getElementById('admEditEmpEmail').value = emp.email || '';
        document.getElementById('admEditEmpPass').value = emp.password || '';
        // 폼 표시
        document.getElementById('editEmployeeFormContainer').classList.remove('hidden');
        // 스크롤 이동 (optional)
        document.getElementById('editEmployeeFormContainer').scrollIntoView({ behavior: 'smooth' });
      };
      document.getElementById('editCancelBtn').addEventListener('click', function() {
        editingEmpId = null;
        document.getElementById('admEditEmployeeForm').reset();
        document.getElementById('editEmployeeFormContainer').classList.add('hidden');
      });
      document.getElementById('admEditEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!editingEmpId) return;
        const name = document.getElementById('admEditEmpName').value.trim();
        const dept = document.getElementById('admEditEmpDept').value.trim();
        const position = document.getElementById('admEditEmpPosition').value.trim();
        const entryDate = document.getElementById('admEditEmpEntry').value;
        const email = document.getElementById('admEditEmpEmail').value.trim();
        const pass = document.getElementById('admEditEmpPass').value.trim();
        if (!name || !dept || !position || !entryDate || !email || !pass) {
          alert('모든 필드를 입력해주세요.');
          return;
        }
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        const idx = employees.findIndex(e => e.id === editingEmpId);
        if (idx === -1) return;
        // 기존 조정 내역을 유지하면서 기본 정보를 업데이트합니다.
        employees[idx] = Object.assign({}, employees[idx], {
          name: name,
          dept: dept,
          position: position,
          entryDate: entryDate,
          email: email,
          password: pass
        });
        // 수정된 입사일을 기준으로 법정 연차를 다시 계산하고 조정 합계를 더해 총 연차를 갱신합니다.
        const legal = calculateLegalLeave(employees[idx]);
        const adjustments = (employees[idx].adjustments || []).reduce((s, adj) => s + adj.amount, 0);
        employees[idx].totalLeave = legal + adjustments;
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('직원 정보가 수정되었습니다.');
        // 숨기고 초기화
        document.getElementById('admEditEmployeeForm').reset();
        document.getElementById('editEmployeeFormContainer').classList.add('hidden');
        editingEmpId = null;
        renderAdmEmployees();
        populateAdmEmployeeFilter();
        renderLeaveDays();
      });

      // ----------- Document Management (Admin) -----------
      // Populate dropdowns for document request form
      function populateDocRequestDropdowns() {
        const empSelect = document.getElementById('admDocEmployee');
        const typeSelect = document.getElementById('admDocType');
        const filterEmpSel = document.getElementById('admDocFilterEmployee');
        const filterTypeSel = document.getElementById('admDocFilterType');
        const employeesList = JSON.parse(localStorage.getItem('employees') || '[]');
        // Populate employee selection for request form
        if (empSelect) {
          empSelect.innerHTML = '<option value="" disabled selected>직원 선택</option>';
          employeesList.forEach(emp => {
            const opt = document.createElement('option');
            opt.value = emp.id;
            opt.textContent = emp.name;
            empSelect.appendChild(opt);
          });
        }
        // Populate employee filter dropdown
        if (filterEmpSel) {
          const currentVal = filterEmpSel.value || 'all';
          filterEmpSel.innerHTML = '';
          const allOpt = document.createElement('option');
          allOpt.value = 'all';
          allOpt.textContent = '전체';
          filterEmpSel.appendChild(allOpt);
          employeesList.forEach(emp => {
            const opt = document.createElement('option');
            opt.value = emp.id;
            opt.textContent = emp.name;
            filterEmpSel.appendChild(opt);
          });
          filterEmpSel.value = currentVal;
        }
        // Populate document types for request form and filters
        docTypes = JSON.parse(localStorage.getItem('docTypes') || '[]');
        if (typeSelect) {
          typeSelect.innerHTML = '<option value="" disabled selected>문서 유형</option>';
          docTypes.forEach(tp => {
            const opt = document.createElement('option');
            opt.value = tp;
            opt.textContent = tp;
            typeSelect.appendChild(opt);
          });
        }
        if (filterTypeSel) {
          const currentType = filterTypeSel.value || 'all';
          filterTypeSel.innerHTML = '';
          const allT = document.createElement('option');
          allT.value = 'all';
          allT.textContent = '전체';
          filterTypeSel.appendChild(allT);
          docTypes.forEach(tp => {
            const opt = document.createElement('option');
            opt.value = tp;
            opt.textContent = tp;
            filterTypeSel.appendChild(opt);
          });
          filterTypeSel.value = currentType;
        }
      }
      // Render document requests list in admin portal
      function renderAdminDocs() {
        const tbody = document.getElementById('admDocRequestsTable');
        if (!tbody) return;
        tbody.innerHTML = '';
        documentRequests = JSON.parse(localStorage.getItem('documentRequests') || '[]');
        const sorted = documentRequests.slice().sort((a,b) => Number(b.id.replace('doc_','')) - Number(a.id.replace('doc_','')));
        // Apply filters
        const empFilterSel = document.getElementById('admDocFilterEmployee');
        const typeFilterSel = document.getElementById('admDocFilterType');
        const empFilter = empFilterSel ? empFilterSel.value : 'all';
        const typeFilter = typeFilterSel ? typeFilterSel.value : 'all';
        const filteredDocs = sorted.filter(doc => {
          if (empFilter && empFilter !== 'all' && doc.employeeId !== empFilter) return false;
          if (typeFilter && typeFilter !== 'all' && doc.type !== typeFilter) return false;
          return true;
        });
        filteredDocs.forEach(doc => {
          const tr = document.createElement('tr');
          const statusText = doc.status === 'pending' ? '요청중' : (doc.status === 'submitted' ? '제출됨' : doc.status);
        const fileLink = doc.fileName && doc.fileData ? `<a href="${doc.fileData}" download="${doc.fileName}" class="text-blue-600 underline">${doc.fileName}</a>` : '-';
        const viewButton = doc.status === 'submitted' ? `<button class="text-blue-600 underline ml-2" onclick="viewDoc('${doc.id}')">보기</button>` : '';
        const submittedAt = doc.submittedAt || '-';
        // Escape any HTML in the submitted text to avoid injection
        const textContent = doc.text ? String(doc.text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '-';
        tr.innerHTML = `
            <td class="px-3 py-2 text-sm">${doc.id}</td>
            <td class="px-3 py-2 text-sm">${doc.employeeName}</td>
            <td class="px-3 py-2 text-sm">${doc.type}</td>
            <td class="px-3 py-2 text-sm">${doc.message || '-'}</td>
            <td class="px-3 py-2 text-sm">${doc.createdAt || '-'}</td>
            <td class="px-3 py-2 text-sm">${statusText}</td>
            <td class="px-3 py-2 text-sm">${submittedAt}</td>
            <td class="px-3 py-2 text-sm break-words">${textContent}</td>
            <td class="px-3 py-2 text-sm">${fileLink}${viewButton}</td>
            <td class="px-3 py-2 text-center text-sm"><button class="text-red-600" onclick="deleteDocRequest('${doc.id}')">삭제</button></td>
          `;
          tbody.appendChild(tr);
        });
      }
      // Handle submission of doc request form
      const admDocRequestForm = document.getElementById('admDocRequestForm');
      if (admDocRequestForm) {
        admDocRequestForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const empId = document.getElementById('admDocEmployee').value;
          const typeVal = document.getElementById('admDocType').value;
          const msg = document.getElementById('admDocMessage').value.trim();
          if (!empId || !typeVal) {
            alert('직원과 문서 유형을 선택하세요.');
            return;
          }
          const employeesList = JSON.parse(localStorage.getItem('employees') || '[]');
          let docs = JSON.parse(localStorage.getItem('documentRequests') || '[]');
          const emp = employeesList.find(e => e.id === empId);
          if (!emp) {
            alert('직원을 찾을 수 없습니다.');
            return;
          }
          const newDoc = {
            id: 'doc_' + Date.now(),
            employeeId: emp.id,
            employeeName: emp.name,
            type: typeVal,
            message: msg,
            status: 'pending',
            createdAt: dayjs().format('YYYY-MM-DD'),
            relatedRequestId: null
          };
          docs.push(newDoc);
          localStorage.setItem('documentRequests', JSON.stringify(docs));
          documentRequests = docs;
          alert('문서 요청이 생성되었습니다.');
          admDocRequestForm.reset();
          renderAdminDocs();
        });
      }
      // Delete document request
      window.deleteDocRequest = function(docId) {
        let docs = JSON.parse(localStorage.getItem('documentRequests') || '[]');
        docs = docs.filter(d => d.id !== docId);
        localStorage.setItem('documentRequests', JSON.stringify(docs));
        documentRequests = docs;
        alert('문서 요청이 삭제되었습니다.');
        renderAdminDocs();
      };
      // -------------------- Document viewing and PDF generation --------------------
      // Generate a simple HTML representation of a submitted document. You can customise
      // the layout here to match your organisation’s preferred document format.
      function generateDocHtml(doc) {
        const created = doc.createdAt || '';
        const submitted = doc.submittedAt || '';
        const message = doc.message || '';
        const content = doc.text || '';
        return `
          <div style="font-family: Arial, sans-serif; line-height:1.6;">
            <h2 style="text-align:center; margin-bottom:1rem;">${doc.type}</h2>
            <p><strong>직원:</strong> ${doc.employeeName} (ID: ${doc.employeeId})${doc.signature ? `<img src="${doc.signature}" style="height:40px; margin-left:10px; display:inline;" />` : ''}</p>
            <p><strong>요청 일자:</strong> ${created}</p>
            <p><strong>제출 일자:</strong> ${submitted}</p>
            ${message ? `<p><strong>요청 메시지:</strong> ${message}</p>` : ''}
            ${content ? `<p><strong>제출 내용:</strong><br/>${content.replace(/\n/g,'<br/>')}</p>` : ''}
            ${doc.fileName ? `<p><strong>첨부 파일:</strong> ${doc.fileName}</p>` : ''}
          </div>
        `;
      }

      // Variable to hold the currently viewed document for PDF download
      let currentDocForPdf = null;

      // Open a modal to view a submitted document
      window.viewDoc = function(docId) {
        documentRequests = JSON.parse(localStorage.getItem('documentRequests') || '[]');
        const doc = documentRequests.find(d => d.id === docId);
        if (!doc) return;
        currentDocForPdf = doc;
        // Ensure docHtml is generated
        if (!doc.docHtml) {
          doc.docHtml = generateDocHtml(doc);
          // persist generated HTML
          localStorage.setItem('documentRequests', JSON.stringify(documentRequests));
        }
        const modal = document.getElementById('docViewModal');
        const contentDiv = document.getElementById('docViewContent');
        if (contentDiv) contentDiv.innerHTML = doc.docHtml;
        if (modal) modal.classList.remove('hidden');
      };

      // Close the document view modal
      window.closeDocView = function() {
        const modal = document.getElementById('docViewModal');
        if (modal) modal.classList.add('hidden');
      };

      // Download the currently viewed document as a PDF
      window.downloadDocPdf = function() {
        if (!currentDocForPdf || !currentDocForPdf.docHtml) return;
        // jsPDF html API is async. Use the exported jspdf in UMD build.
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        // Create a temporary container to render HTML for pdf conversion
        const temp = document.createElement('div');
        temp.style.width = '595px';
        temp.style.padding = '20px';
        temp.innerHTML = currentDocForPdf.docHtml;
        document.body.appendChild(temp);
        pdf.html(temp, {
          callback: function (pdf) {
            pdf.save(`${currentDocForPdf.id}.pdf`);
            document.body.removeChild(temp);
          },
          margin: [10, 10, 10, 10],
          autoPaging: 'text',
        });
      };
      // Expose renderAdminDocs globally so employee submission can update admin view
      window.renderAdminDocs = renderAdminDocs;

      // Attach filter change handlers for document management
      const docEmpFilter = document.getElementById('admDocFilterEmployee');
      if (docEmpFilter) docEmpFilter.addEventListener('change', renderAdminDocs);
      const docTypeFilter = document.getElementById('admDocFilterType');
      if (docTypeFilter) docTypeFilter.addEventListener('change', renderAdminDocs);
      const docFilterReset = document.getElementById('admDocFilterReset');
      if (docFilterReset) docFilterReset.addEventListener('click', function() {
        const empSel = document.getElementById('admDocFilterEmployee');
        const typeSel = document.getElementById('admDocFilterType');
        if (empSel) empSel.value = 'all';
        if (typeSel) typeSel.value = 'all';
        renderAdminDocs();
      });

      // ----- 연차 일수 관리 함수들 -----
      // 법정 연차 계산 (한국 근로기준법 간단화: 1년 미만 입사자는 매달 1개씩 최대 11일까지, 1년 이상 근속자는 15일에 2년마다 1일 가산)
      function calculateLegalLeave(emp) {
        if (!emp || !emp.entryDate) return 0;
        const entry = dayjs(emp.entryDate);
        const today = dayjs();
        const years = today.diff(entry, 'year', true);
        let legal;
        if (years < 1) {
          const months = today.diff(entry, 'month');
          legal = Math.min(months + 1, 11);
        } else {
          const fullYears = Math.floor(years);
          legal = 15 + Math.floor((fullYears - 1) / 2);
        }
        return legal;
      }

      /**
       * Render a summary table of all employees' leave status (총 연차, 사용 연차, 잔여 연차, 갱신일).
       * This function is called when the '직원 목록' tab is selected.
       */
      window.renderAdmEmployeeSummary = function() {
        const tbody = document.getElementById('admEmployeeSummaryTable');
        if (!tbody) return;
        tbody.innerHTML = '';
        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
        const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        const today = dayjs();
        employees.forEach(emp => {
          // Compute total legal leave and adjustments
          const legal = calculateLegalLeave(emp);
          const adjSum = (emp.adjustments || []).reduce((sum, a) => sum + a.amount, 0);
          const totalLeave = legal + adjSum;
          // Count used (past approved) and future approved
          let used = 0;
          let futureApproved = 0;
          requests.forEach(req => {
            if (req.employeeId !== emp.id) return;
            if (req.status !== 'approved') return;
            req.dates.forEach(dateStr => {
              const d = dayjs(dateStr);
              if (d.isBefore(today, 'day')) used++;
              else futureApproved++;
            });
          });
          const remaining = totalLeave - used - futureApproved;
          // Compute next renewal date based on entry date
          let renewal = '';
          if (emp.entryDate) {
            const entry = dayjs(emp.entryDate);
            let next = entry.year(today.year()).month(entry.month()).date(entry.date());
            if (next.isBefore(today, 'day')) {
              next = next.add(1, 'year');
            }
            renewal = next.format('YYYY-MM-DD');
          }
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-3 py-2 text-sm">${emp.name}</td>
            <td class="px-3 py-2 text-sm">${emp.dept || '-'}</td>
            <td class="px-3 py-2 text-sm">${emp.position || '-'}</td>
            <td class="px-3 py-2 text-sm">${totalLeave}</td>
            <td class="px-3 py-2 text-sm">${used}</td>
            <td class="px-3 py-2 text-sm">${remaining}</td>
            <td class="px-3 py-2 text-sm">${renewal || '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      };
      // 다음 갱신일 계산 (연차 기준일을 기준으로 다음 해의 동일한 날짜)
      function getNextRenewalDate(emp) {
        if (!emp || !emp.entryDate) return '-';
        const baseStr = emp.annualBaseDate || emp.entryDate;
        const base = dayjs(baseStr);
        if (!base.isValid()) return '-';
        const today = dayjs();
        let next = base.year(today.year());
        if (next.isBefore(today, 'day')) {
          next = next.add(1, 'year');
        }
        return next.format('YYYY-MM-DD');
      }
      // 연차 관리 테이블 렌더링
      function renderLeaveDays() {
        const tbody = document.getElementById('leaveDaysTable');
        if (!tbody) return;
        tbody.innerHTML = '';
        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
        employees.forEach(emp => {
          const legal = calculateLegalLeave(emp);
          const adjustments = (emp.adjustments || []).reduce((sum, adj) => sum + adj.amount, 0);
          // 총 연차는 법정 연차와 가감 합계를 더하여 계산합니다
          const total = legal + adjustments;
          const base = emp.annualBaseDate || emp.entryDate || '';
          const nextRenewal = getNextRenewalDate(emp);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-2 py-1 text-sm">${emp.name || '-'}</td>
            <td class="px-2 py-1 text-sm">${emp.entryDate || '-'}</td>
            <td class="px-2 py-1 text-sm"><input type="date" class="border p-1 rounded w-full" value="${base}" onchange="updateBaseDate('${emp.id}', this.value)" /></td>
            <td class="px-2 py-1 text-sm">${nextRenewal}</td>
            <td class="px-2 py-1 text-sm">${legal}</td>
            <td class="px-2 py-1 text-sm">${adjustments}</td>
            <td class="px-2 py-1 text-sm">${total}</td>
            <td class="px-2 py-1 text-sm"><input id="adjustVal_${emp.id}" type="number" class="border p-1 rounded w-20" /></td>
            <td class="px-2 py-1 text-sm"><input id="adjustReason_${emp.id}" type="text" class="border p-1 rounded" /></td>
            <td class="px-2 py-1 text-sm"><button class="bg-blue-500 text-white px-2 py-1 rounded" onclick="applyLeaveAdjustment('${emp.id}')">적용</button></td>
          `;
          tbody.appendChild(tr);
        });
      }
      // Expose key rendering functions globally so they can be called outside this scope (e.g., from deleteRequest)
      window.renderAdmEmployees = renderAdmEmployees;
      window.renderAdmRequestTable = renderAdmRequestTable;
      window.renderAdmCalendar = renderAdmCalendar;
      window.renderLeaveDays = renderLeaveDays;
      // 연차 가감 적용
      window.applyLeaveAdjustment = function(id) {
        const valInput = document.getElementById('adjustVal_' + id);
        const reasonInput = document.getElementById('adjustReason_' + id);
        const valRaw = valInput.value;
        const val = parseInt(valRaw, 10);
        const reason = reasonInput.value.trim();
        // If both fields are empty, treat as no adjustment (ignore silently)
        if ((!valRaw || valRaw === '') && reason === '') {
          // No adjustment specified, simply return without alert
          return;
        }
        // If only one of amount or reason is missing or amount is zero, show validation message
        if (isNaN(val) || val === 0 || !reason) {
          alert('가감 일수와 사유를 모두 입력하세요.');
          return;
        }
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        const emp = employees.find(e => e.id === id);
        if (!emp) return;
        // 조정 내역을 업데이트하고 총 연차를 다시 계산합니다.
        if (!emp.adjustments) emp.adjustments = [];
        emp.adjustments.push({ amount: val, reason: reason, date: dayjs().format('YYYY-MM-DD') });
        // 총 연차는 법정 연차와 가감 합계를 더하여 계산
        const legal = calculateLegalLeave(emp);
        const adjSum = emp.adjustments.reduce((sum, a) => sum + a.amount, 0);
        emp.totalLeave = legal + adjSum;
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('연차가 조정되었습니다.');
        // reset inputs
        valInput.value = '';
        reasonInput.value = '';
        renderLeaveDays();
        renderAdmEmployees();
      };
      // 연차 기준일 변경
      window.updateBaseDate = function(id, value) {
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        const emp = employees.find(e => e.id === id);
        if (!emp) return;
        emp.annualBaseDate = value;
        // 연차 기준일이 변경되면 법정 연차를 다시 계산하고 총 연차를 갱신합니다.
        const legal = calculateLegalLeave(emp);
        const adjSum = (emp.adjustments || []).reduce((sum, a) => sum + a.amount, 0);
        emp.totalLeave = legal + adjSum;
        localStorage.setItem('employees', JSON.stringify(employees));
        renderLeaveDays();
      };

      // init admin portal
      renderAdmEmployees();
      renderAdmRequestTable();
      renderAdmCalendar();
      // 연차 일수 관리 초기 렌더링
      renderLeaveDays();
      showAdminSection('list');
    }

    function adminLogout() {
      localStorage.removeItem('loggedInOwner');
      location.reload();
    }

    // --------------- Employee Dashboard Modal (Admin) ---------------
    let admDashCalendar = null;
    /**
     * Show a selected employee's annual leave dashboard for managers.
     * Displays summary and calendar in a modal overlay.
     */
    window.viewEmployeeDashboard = function(empId) {
      const employees = JSON.parse(localStorage.getItem('employees') || '[]');
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;
      // Compute legal leave days using the same logic as calculateLegalLeave
      function computeLegal(e) {
        if (!e || !e.entryDate) return 0;
        const entry = dayjs(e.entryDate);
        const today = dayjs();
        const years = today.diff(entry, 'year', true);
        let legal;
        if (years < 1) {
          const months = today.diff(entry, 'month');
          legal = Math.min(months + 1, 11);
        } else {
          const fullYears = Math.floor(years);
          legal = 15 + Math.floor((fullYears - 1) / 2);
        }
        return legal;
      }
      const legal = computeLegal(emp);
      const adjSum = (emp.adjustments || []).reduce((sum, a) => sum + a.amount, 0);
      const totalLeave = legal + adjSum;
      // Compute pending/approved/used/remaining days for this employee
      const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
      let pending = 0, approved = 0, used = 0;
      const today = dayjs();
      requests.forEach(req => {
        if (req.employeeId !== emp.id) return;
        req.dates.forEach(date => {
          const d = dayjs(date);
          if (req.status === 'pending') pending++;
          else if (req.status === 'approved') {
            if (d.isBefore(today, 'day')) used++; else approved++;
          }
        });
      });
      const remaining = totalLeave - approved - used;
      // Populate summary boxes
      const summaryContainer = document.getElementById('admDashSummary');
      summaryContainer.innerHTML = '';
      const summaries = [
        { label: '총 연차', value: totalLeave + '일', bg: 'bg-blue-100' },
        { label: '승인 대기', value: pending + '일', bg: 'bg-yellow-100' },
        { label: '승인 완료', value: approved + '일', bg: 'bg-green-100' },
        { label: '사용 연차', value: used + '일', bg: 'bg-gray-200' },
        { label: '잔여 연차', value: remaining + '일', bg: 'bg-red-100' }
      ];
      summaries.forEach(s => {
        const div = document.createElement('div');
        div.className = `${s.bg} p-3 rounded`;
        div.innerHTML = `<p>${s.label}</p><p class="text-xl font-bold">${s.value}</p>`;
        summaryContainer.appendChild(div);
      });
      // Set title
      document.getElementById('admDashTitle').textContent = emp.name + ' 님 연차 대시보드';
      // Prepare calendar events with department and status colouring
      const events = [];
      // assign department colors (for all employees) using the same palette as admin calendar
      const palette = ['#bbf7d0', '#fecaca', '#fde68a', '#bfdbfe', '#ddd6fe', '#fed7aa', '#fcd34d', '#fbcfe8'];
      const employeesAll = JSON.parse(localStorage.getItem('employees') || '[]');
      const deptColors = {};
      let idx = 0;
      employeesAll.forEach(e => {
        const d = e.dept;
        if (d && !deptColors[d]) {
          deptColors[d] = palette[idx % palette.length];
          idx++;
        }
      });
      requests.forEach(req => {
        if (req.employeeId !== emp.id) return;
        // Determine status colour for indicator
        let statusColor;
        if (req.status === 'pending') statusColor = '#facc15';
        else if (req.status === 'approved') {
          const endDate = dayjs(req.dates[req.dates.length - 1]);
          statusColor = endDate.isBefore(today, 'day') ? '#a3a3a3' : '#34d399';
        } else if (req.status === 'rejected') statusColor = '#f87171';
        else statusColor = '#a3a3a3';
        const bgColor = deptColors[emp.dept] || '#e5e7eb';
        req.dates.forEach(date => {
          events.push({
            title: emp.name,
            start: date,
            allDay: true,
            backgroundColor: bgColor,
            borderColor: bgColor,
            textColor: '#000000',
            extendedProps: { statusColor: statusColor }
          });
        });
      });
      // Destroy previous calendar instance if exists
      if (admDashCalendar) {
        admDashCalendar.destroy();
        admDashCalendar = null;
      }
      // Initialize new FullCalendar for the employee dashboard with status indicator
      const calEl = document.getElementById('admDashCalendar');
      admDashCalendar = new FullCalendar.Calendar(calEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        events: events,
        eventContent: function(arg) {
          const dotColor = arg.event.extendedProps.statusColor;
          const title = arg.event.title;
          return { html: `<div class="flex items-center"><span style="background-color:${dotColor};width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:4px;"></span><span>${title}</span></div>` };
        }
      });
      admDashCalendar.render();
      // Show modal
      document.getElementById('admEmployeeDashboardModal').classList.remove('hidden');
    };

    /**
     * Close the employee dashboard modal and clean up calendar instance.
     */
    window.closeAdmEmployeeDashboard = function() {
      const modal = document.getElementById('admEmployeeDashboardModal');
      if (modal) modal.classList.add('hidden');
      if (admDashCalendar) {
        admDashCalendar.destroy();
        admDashCalendar = null;
      }
    };

    /**
     * 제출해야 할 문서에 대한 제출 처리 함수.
     * 직원이 문서를 작성하거나 파일을 첨부하여 제출하면 상태를 'submitted'로 변경합니다.
     * @param {string} docId - 문서 요청 ID
     */
    window.submitDocument = function(docId) {
      // Always reload the latest documentRequests from localStorage in case admin has issued new document requests since page load.
      documentRequests = JSON.parse(localStorage.getItem('documentRequests') || '[]');
      const idx = documentRequests.findIndex(doc => doc.id === docId);
      if (idx === -1) return;
      const textEl = document.getElementById('docText_' + docId);
      const fileEl = document.getElementById('docFile_' + docId);
      const text = textEl ? textEl.value.trim() : '';
      const file = fileEl && fileEl.files && fileEl.files.length > 0 ? fileEl.files[0] : null;
      if (!text && !file) {
        alert('내용 또는 파일을 입력해주세요.');
        return;
      }
      // Helper to update the document request and refresh UI. Accepts signature data.
      function finishSubmission(fileData, fileName, signatureData) {
        documentRequests[idx].status = 'submitted';
        documentRequests[idx].submittedAt = dayjs().format('YYYY-MM-DD');
        documentRequests[idx].text = text;
        documentRequests[idx].fileName = fileName || '';
        documentRequests[idx].fileData = fileData || '';
        // Save the signature captured from the modal
        documentRequests[idx].signature = signatureData || '';
        // Generate an HTML representation of the submitted document for admin viewing and PDF
        if (typeof generateDocHtml === 'function') {
          documentRequests[idx].docHtml = generateDocHtml(documentRequests[idx]);
        }
        localStorage.setItem('documentRequests', JSON.stringify(documentRequests));
        alert('문서가 제출되었습니다.');
        // Refresh employee doc list and button state (functions exposed globally)
        if (typeof window.renderEmpDocList === 'function') window.renderEmpDocList();
        if (typeof window.updateApplyButtonState === 'function') window.updateApplyButtonState();
        // Refresh admin document view if present
        if (typeof window.renderAdminDocs === 'function') window.renderAdminDocs();
      }
      // Show signature modal and handle asynchronous flows for file reading
      showSignatureModal(function(signatureData) {
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            finishSubmission(ev.target.result, file.name, signatureData);
          };
          reader.readAsDataURL(file);
        } else {
          finishSubmission('', '', signatureData);
        }
      });
    };

    // ----------------- 중간 관리자 기능 -----------------
    /**
     * Load managers from localStorage. If none exist, create a default manager account.
     * @returns {Array} managers array
     */
    function loadManagers() {
      let managers = JSON.parse(localStorage.getItem('managers') || '[]');
      if (!managers || managers.length === 0) {
        managers = [{ id: 'manager', password: '1234', name: '중간 관리자' }];
        localStorage.setItem('managers', JSON.stringify(managers));
      }
      return managers;
    }

    // Handle middle manager login
    document.getElementById('managerLoginForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('managerLoginId').value.trim();
      const pass = document.getElementById('managerLoginPass').value.trim();
      const managers = loadManagers();
      const match = managers.find(m => m.id === id && m.password === pass);
      if (!match) {
        alert('중간 관리자 정보가 일치하지 않습니다.');
        return;
      }
      localStorage.setItem('loggedInManager', JSON.stringify(match));
      alert(match.name + '님 로그인되었습니다.');
      showManagerPortal();
    });

    /**
     * Show manager portal and hide other sections
     */
    function showManagerPortal() {
      const loginSec = document.getElementById('loginSection');
      if (loginSec) loginSec.classList.add('hidden');
      const empPortal = document.getElementById('employeePortal');
      if (empPortal) empPortal.classList.add('hidden');
      const admPortal = document.getElementById('adminPortal');
      if (admPortal) admPortal.classList.add('hidden');
      const mgrPortal = document.getElementById('managerPortal');
      if (mgrPortal) mgrPortal.classList.remove('hidden');
      initializeManagerPortal();
    }

    /**
     * Initialize manager portal by checking login and rendering request table
     */
    function initializeManagerPortal() {
      const mgr = JSON.parse(localStorage.getItem('loggedInManager') || 'null');
      if (!mgr) {
        // If not logged in, show employee login by default
        showEmployeeLogin();
        return;
      }
      refreshManagerPortal();
    }

    /**
     * Refresh the manager request table
     */
    function refreshManagerPortal() {
      const tbody = document.getElementById('mgrRequestTable');
      if (!tbody) return;
      tbody.innerHTML = '';
      const requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
      requests.forEach(req => {
        const mgrStatus = req.managerStatus || 'pending';
        const finalStatus = req.status;
        const tr = document.createElement('tr');
        // Determine actions: only if final status is pending and manager status is pending
        let actions = '';
        if (finalStatus === 'pending') {
          if (mgrStatus === 'pending') {
            actions += `<button class="text-green-600 mr-2" onclick="managerApproveRequest('${req.id}')">승인</button>`;
            actions += `<button class="text-red-600" onclick="managerRejectRequest('${req.id}')">반려</button>`;
          } else {
            actions = '-';
          }
        } else {
          actions = '-';
        }
        tr.innerHTML = `
          <td class="px-4 py-2 text-sm">${req.id}</td>
          <td class="px-4 py-2 text-sm">${req.employeeName}</td>
          <td class="px-4 py-2 text-sm">${Array.isArray(req.dates) ? req.dates.join(', ') : ''}</td>
          <td class="px-4 py-2 text-sm">${req.reason || ''}</td>
          <td class="px-4 py-2 text-sm">${req.submittedAt || req.submissionDate || '-'}</td>
          <td class="px-4 py-2 text-sm">${mgrStatus}</td>
          <td class="px-4 py-2 text-sm">${finalStatus}</td>
          <td class="px-4 py-2 text-center text-sm">${actions}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /**
     * Manager approves a leave request
     * @param {string} id Request ID
     */
    function managerApproveRequest(id) {
      let requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
      const idx = requests.findIndex(r => r.id === id);
      if (idx === -1) return;
      // Only allow if final status is pending
      if (requests[idx].status !== 'pending') {
        alert('이미 최종 결재가 완료되었습니다.');
        return;
      }
      requests[idx].managerStatus = 'approved';
      localStorage.setItem('leaveRequests', JSON.stringify(requests));
      alert('중간 관리자 승인 처리되었습니다.');
      refreshManagerPortal();
      if (typeof renderAdmRequestTable === 'function') {
        renderAdmRequestTable();
        renderAdmCalendar();
      }
    }

    /**
     * Manager rejects a leave request
     * @param {string} id Request ID
     */
    function managerRejectRequest(id) {
      let requests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
      const idx = requests.findIndex(r => r.id === id);
      if (idx === -1) return;
      if (requests[idx].status !== 'pending') {
        alert('이미 최종 결재가 완료되었습니다.');
        return;
      }
      requests[idx].managerStatus = 'rejected';
      localStorage.setItem('leaveRequests', JSON.stringify(requests));
      alert('중간 관리자 반려 처리되었습니다.');
      refreshManagerPortal();
      if (typeof renderAdmRequestTable === 'function') {
        renderAdmRequestTable();
        renderAdmCalendar();
      }
    }

    /**
     * Manager logout: remove login state and return to login screen
     */
    function managerLogout() {
      localStorage.removeItem('loggedInManager');
      const mgrPortal = document.getElementById('managerPortal');
      if (mgrPortal) mgrPortal.classList.add('hidden');
      const loginSec = document.getElementById('loginSection');
      if (loginSec) loginSec.classList.remove('hidden');
      const empPortal = document.getElementById('employeePortal');
      if (empPortal) empPortal.classList.add('hidden');
      const admPortal = document.getElementById('adminPortal');
      if (admPortal) admPortal.classList.add('hidden');
    }

    /**
     * Format an array of date strings into a human-friendly representation.
     * Dates with the same month are grouped together so that the month is shown once
     * and the days follow separated by commas. For example:
     * ['2025-08-01','2025-08-02','2025-09-05'] -> '8월 01,02 / 9월 05'
     * @param {string[]} dates
     * @returns {string}
     */
    window.formatDateList = function(dates) {
      if (!Array.isArray(dates) || dates.length === 0) return '';
      // group by year-month
      const groups = {};
      dates.forEach(d => {
        const [y, m, day] = d.split('-');
        const key = `${y}-${m}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(day);
      });
      const parts = [];
      for (const key of Object.keys(groups)) {
        const [y, m] = key.split('-');
        const days = groups[key]
          .map(d => parseInt(d, 10))
          .sort((a,b) => a - b)
          .map(n => String(n).padStart(2, '0'));
        // Show month number without leading zero and Korean unit
        parts.push(`${parseInt(m, 10)}월 ${days.join(',')}`);
      }
      return parts.join(' / ');
    };
  </script>
</body>
</html>
